<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Version 2.1 September 2024">
<title>Repast for Python (Repast4Py) User Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Repast for Python (Repast4Py) User Guide</h1>
<div class="details">
<span id="author" class="author">Version 2.1 September 2024</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_getting_started">1. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_requirements">1.1. Requirements</a></li>
<li><a href="#_installation">1.2. Installation</a></li>
<li><a href="#_documentation">1.3. Documentation</a></li>
<li><a href="#_contact_and_support">1.4. Contact and Support</a></li>
</ul>
</li>
<li><a href="#_why_repast4py">2. Why Repast4Py?</a>
<ul class="sectlevel2">
<li><a href="#_distributed_computing_a_natural_fit_for_agent_based_modeling">2.1. Distributed computing a natural fit for agent-based modeling</a></li>
<li><a href="#_repast4py_and_the_broader_repast_family">2.2. Repast4Py and the broader Repast family</a></li>
</ul>
</li>
<li><a href="#_repast_simulation_overview">3. Repast Simulation Overview</a>
<ul class="sectlevel2">
<li><a href="#_contexts_and_projections">3.1. Contexts and Projections</a></li>
<li><a href="#_scheduling_events">3.2. Scheduling Events</a></li>
<li><a href="#_distributed_simulation">3.3. Distributed Simulation</a></li>
</ul>
</li>
<li><a href="#_cross_process_code_requirements">4. Cross-Process Code Requirements</a>
<ul class="sectlevel2">
<li><a href="#_agent_id">4.1. Agent ID</a></li>
<li><a href="#_saving_and_restoring_agents">4.2. Saving and Restoring Agents</a></li>
<li><a href="#_synchronization">4.3. Synchronization</a></li>
</ul>
</li>
<li><a href="#_tutorial_1_a_simple_random_walk_model">5. Tutorial 1 - A Simple Random Walk Model</a>
<ul class="sectlevel2">
<li><a href="#_the_walker_agent">5.1. The Walker Agent</a></li>
<li><a href="#_the_model_class">5.2. The Model Class</a></li>
<li><a href="#_restoring_walkers">5.3. Restoring Walkers</a></li>
<li><a href="#_running_the_simulation">5.4. Running the Simulation</a></li>
</ul>
</li>
<li><a href="#_tutorial_2_the_rumor_network_model">6. Tutorial 2 - The Rumor Network Model</a>
<ul class="sectlevel2">
<li><a href="#_overview">6.1. Overview</a></li>
<li><a href="#_the_network">6.2. The Network</a></li>
<li><a href="#_the_rumor_model_implementation">6.3. The Rumor Model Implementation</a></li>
</ul>
</li>
<li><a href="#_tutorial_3_the_zombies_model">7. Tutorial 3 - The Zombies Model</a>
<ul class="sectlevel2">
<li><a href="#_the_agent_classes">7.1. The Agent Classes</a></li>
<li><a href="#_the_model_class_3">7.2. The Model class</a></li>
<li><a href="#_the_grid_neighborhood_finder">7.3. The Grid Neighborhood Finder</a></li>
<li><a href="#_running_the_simulation_3">7.4. Running the Simulation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_getting_started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Repast for Python (Repast4Py) is the newest member of the <a href="https://repast.github.io">Repast Suite</a> of free and open source agent-based modeling and simulation software.
It builds on <a href="https://repast.github.io/repast_hpc.html">Repast HPC</a>, and provides the ability to build large, distributed agent-based models (ABMs) that span multiple processing cores.
Distributed ABMs enable the development of complex systems models that capture the scale and relevant details of many problems of societal importance.&#8288;<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>&#8288;<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>
Where Repast HPC is implemented in C++ and is more HPC expert focused, Repast4Py is a Python package and is designed to provide an easier on-ramp for researchers from diverse scientific communities to apply large-scale distributed ABM methods. Repast4Py is released under the BSD-3 open source license, and leverages <a href="https://numba.pydata.org">Numba</a>, <a href="https://numpy.org">NumPy</a>, and <a href="https://pytorch.org">PyTorch</a> packages, and the Python C API
to create a scalable modeling system that can exploit the largest HPC resources and emerging computing architectures. See our paper on Repast4Py for additional information about the design and implementation.&#8288;<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
<div class="sect2">
<h3 id="_requirements">1.1. Requirements</h3>
<div class="paragraph">
<p>Repast4Py can run on Linux, macOS and Windows provided there is a working MPI implementation
installed and mpi4py is supported. Repast4Py is developed and tested on Linux. We recommend
that Windows users use the Windows Subsystem for Linux (WSL). Installation instructions for
WSL can be found <a href="https://docs.microsoft.com/en-us/windows/wsl/install">here</a>.</p>
</div>
<div class="paragraph">
<p>Under Linux, MPI can be installed using your OS&#8217;s package manager. For example,
under Ubuntu 22.04 (and thus WSL), the mpich MPI implementation can be installed with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ sudo apt install mpich</code></pre>
</div>
</div>
<div class="paragraph">
<p>Installation instructions for MPI on macOS can be found <a href="https://repast.github.io/repast4py.site/macos_mpi_install.html">here</a>.</p>
</div>
<div class="paragraph">
<p>A typical campus cluster, or HPC resource will have MPI and mpi4py installed.
Check the resource&#8217;s documentation on available software for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation">1.2. Installation</h3>
<div class="paragraph">
<p>Repast4Py can be downloaded and installed from PyPI using pip.
Since Repast4Py includes native MPI C&#43;&#43; code that needs to be compiled,
the C compiler <code>CC</code> environment variable must be set
to the <code>mpicxx</code> (or <code>mpic++</code>) compiler wrapper provided by your MPI installation.
Depending on the operating system, the <code>CXX</code> variable may also need to be set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>env CC=mpicxx CXX=mpicxx pip install repast4py</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error message about a missing <code>python.h</code> header file when
installing Repast4Py under Ubuntu (or other Linuxes), you will need to install
a python dev package using your OS&#8217;s package manager. For example, assuming
Python 3.8, <code>sudo apt install python3.8-dev</code> will work for Ubuntu.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_documentation">1.3. Documentation</h3>
<div class="ulist">
<ul>
<li>
<p><a href="./user_guide.html">User&#8217;s Guide</a> (This document)</p>
</li>
<li>
<p><a href="https://repast.github.io/repast4py.site/apidoc/index.html">API Docs</a></p>
</li>
<li>
<p><a href="https://repast.github.io/repast4py.site/examples/examples.html">Example Models</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_contact_and_support">1.4. Contact and Support</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/Repast/repast4py/issues">GitHub Issues</a></p>
</li>
<li>
<p><a href="https://github.com/Repast/repast4py">GitHub Repository</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to filing issues on GitHub, support is also available via
<a href="https://stackoverflow.com/questions/tagged/repast4py">Stack Overflow</a>.
Please use the <code>repast4py</code> tag to ensure that we are notified of your question.
Software announcements will be made on the
<a href="http://lists.sourceforge.net/lists/listinfo/repast-interest">repast-interest</a> mailing list.</p>
</div>
<div class="paragraph">
<p>Jonathan Ozik is the Repast project lead. Please contact him through
the <a href="https://www.anl.gov/staff-directory">Argonne Staff Directory</a> if you
have project-related questions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_repast4py">2. Why Repast4Py?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Modern high-performance computing (HPC) capabilities have allowed for large-scale computational modeling and experimentation.
HPC clusters and supercomputers&#8201;&#8212;&#8201;such as those hosted by universities, national laboratories, and cloud computing providers&#8201;&#8212;&#8201;can have thousands or more processor cores available, allowing for high concurrency.
Even individual CPUs now typically contain multiple cores, which are capable of running concurrently.
Distributed ABMs attempt to leverage this hardware by distributing an individual simulation over multiple processes running in parallel.</p>
</div>
<div class="paragraph">
<p>However, in order to take advantage of these increasingly ubiquitous parallel computing resources, a computational model must first be refashioned to run on multiple processors.
Adapting a computational model that was built for a single processor to run on multiple processors can be a nontrivial endeavor, both conceptually and practically.
Repast4Py aims to ease the transition to distributed ABMs by hiding much of the complexity.</p>
</div>
<div class="sect2">
<h3 id="_distributed_computing_a_natural_fit_for_agent_based_modeling">2.1. Distributed computing a natural fit for agent-based modeling</h3>
<div class="paragraph">
<p>A typical agent-based simulation consists of a population of agents each of which performs some behavior each timestep or at some frequency.
In practice, this is often implemented as a loop over the agent population in which each agent executes its behavior.
The time it takes to complete the loop depends on the number of agents and the complexity of the behavior.
By distributing the agent population across multiple processes running in parallel, each process executes its own loop over only a subset of the population, allowing for larger agent populations and more complex behavior.</p>
</div>
</div>
<div class="sect2">
<h3 id="_repast4py_and_the_broader_repast_family">2.2. Repast4Py and the broader Repast family</h3>
<div class="paragraph">
<p>While Repas4Py is meant to make the development of distributed ABMs easier, we encourage users new to the Repast Suite to look through the different versions of <a href="https://repast.github.io/docs.html">Repast</a> to determine which toolkit is most appropriate for their needs. Of note, we recommend users new to agent-based modeling to first check out <a href="https://repast.github.io/repast_simphony.html">Repast Simphony</a> to develop a better understanding of the concepts behind agent-based modeling and learn how to quickly build such models.</p>
</div>
<div class="paragraph">
<p>The following sections will provide some conceptual background for a Repast-style simulation, describe how such a simulation is distributed across multiple processes with Repast4Py, and end with providing a few basic tutorials.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repast_simulation_overview">3. Repast Simulation Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This overview section will provide some conceptual background for a Repast-style simulation
as well as describing how such a simulation is distributed across multiple processes.</p>
</div>
<div class="sect2">
<h3 id="_contexts_and_projections">3.1. Contexts and Projections</h3>
<div class="paragraph">
<p>Like the other members of the Repast ABM family, Repast4Py organizes a model in terms of <strong><em>contexts</em></strong> and <strong><em>projections</em></strong>.
A context is a simple container with set semantics. Any type of object can be put into a context, with the simple caveat that only one instance of any given object
can be contained by the context. From a modeling perspective, the context represents a population of agents. The agents in a context are the population of a model.
However, the context does not inherently provide any relationship or structure for that population. Projections take the population as defined in a context
and impose a structure on it. Actual projections are
such things as a network structure that allows agents to form links (network type relations) with each other, a grid where each agent is located in a
matrix-type space, or a continuous space where an agent&#8217;s location is expressible as a non-discrete coordinate. Projections have a many-to-one relationship with
contexts. Each context can have an arbitrary number of projections associated with it. When writing a model, you will create a context, populate it with agents,
and attach projections to that context.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scheduling_events">3.2. Scheduling Events</h3>
<div class="paragraph">
<p>A Repast simulation moves forward by repeatedly determining the next event to execute and then executing that event.
Events in Repast simulations are driven by a discrete-event scheduler. These events are scheduled to occur at a
particular <strong><em>tick</em></strong>. Ticks do not necessarily represent clock-time but rather the priority of an associated event.
In this way, ticks determine the order in which events occur with respect to each other. For example, if event A is scheduled at tick 3 and
event B at tick 6, event A will occur before event B.  Assuming nothing is scheduled at the intervening ticks, A will be
immediately followed by B. There is no inherent notion of B occurring after a duration of 3 ticks.  Of course, ticks can and
are often given some temporal significance through the model implementation. A traffic simulation, for example, may move the
traffic forward the equivalent of 30 seconds for each tick. Events can also be scheduled dynamically
such that the execution of an event may schedule further events at that same or at some future tick. When writing a model, you will
create a Schedule object and schedule events using that object. The events are essentially Python Callables (methods or functions)
scheduled for execution at some particular tick or tick frequency.</p>
</div>
</div>
<div class="sect2">
<h3 id="_distributed_simulation">3.3. Distributed Simulation</h3>
<div class="paragraph">
<p>Repast4Py was designed from the ground up as a distributed simulation framework. In practice, this means
that the simulation is spread over multiple computer processes none of which have access to each other&#8217;s memory, and
communicate via message passing using the Message Passing Interface (MPI) and its Python implementation MPI for Python
<a href="https://mpi4py.readthedocs.io/en/stable/">(mpi4py)</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Repast4Py can also be used to implement a non-distributed simulation by restricting the simulation
to a single process.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Repast4Py distributes a simulation by providing <em>shared</em> implementations of the components described above.
By shared, we want to emphasize the partitioned and distributed nature of the simulation. The global simulation
is shared among a pool of processes, each of which is responsible for some portion of it, and stiched into a global whole through the use of non-local, or <em>ghost</em>, agents and buffered projections.</p>
</div>
<div class="paragraph">
<p>An MPI application identifies its processes by a rank id. For example, if the application is run with 4 processes, there
will be 4 ranks: 0 - 3. The code in an MPI appliction is run concurrently on each rank. Anything
instantiated in that code resides in that processes' memory and is <strong><em>local</em></strong> to that process. Other processes do not
have access to the variables, objects, etc. created on another process. A simple "hello world" type
MPI4Py script illustrates this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c1"># hello_world.py</span>
<span class="tok-kn">from</span> <span class="tok-nn">mpi4py</span> <span class="tok-kn">import</span> <span class="tok-n">MPI</span>

<span class="tok-n">size</span> <span class="tok-o">=</span> <span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-o">.</span><span class="tok-n">Get_size</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">rank</span> <span class="tok-o">=</span> <span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-o">.</span><span class="tok-n">Get_rank</span><span class="tok-p">()</span>    <i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s1">&#39;Hello, World! I am process </span><span class="tok-si">{}</span><span class="tok-s1"> of </span><span class="tok-si">{}</span><span class="tok-s1">&#39;</span><span class="tok-o">.</span><span class="tok-n">format</span><span class="tok-p">(</span><span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-p">))</span>    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets the world size, that is, the total number of process ranks.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Gets the rank of the process the code is running on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Prints out the size and current rank.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running this with 4 process ranks (<code><code>mpirun -n 4 python hello_world.py</code></code>) will produce
something like following output where can see how each of the 4 ranks
runs the script independently on its own process rank.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>Hello, World! I am process 2 of 4
Hello, World! I am process 1 of 4
Hello, World! I am process 0 of 4
Hello, World! I am process 3 of 4</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The output may be more mixed together than the above example as each process
writes it output concurrently.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In a more ABM flavored example, assuming 4 ranks, the following code
creates 10 agents on each rank, for a total of 40 agents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">for</span> <span class="tok-n">i</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-mi">10</span><span class="tok-p">):</span>
    <span class="tok-n">agent</span> <span class="tok-o">=</span> <span class="tok-n">MyAgent</span><span class="tok-p">()</span>
    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>These agents are said to be <strong><em>local</em></strong> to the ranks on which they are created. In order to stitch these individual ranks
into a global whole, Repast4Py uses the concept of a non-local, <em>ghost</em> agent: a copy of an agent from another rank
that local agents can interact with. Repast4Py provides the functionality to create these ghosts and keep their
state synchronized from the ghosts' local ranks to the ranks on which they are ghosted. Ghosts are also used to create
projections, such as a network or grid that span across process ranks.</p>
</div>
<div class="paragraph">
<p><a href="#img-network-ghost">Figure 1</a> illustrates how ghosts are used in a network projection. The top part of the figure shows that agent <code>A1</code> is local to process 1 and has
a directed netework link to agent <code>B2</code>, which is local to process 2. Presumably, some aspect of the agent&#8217;s behavior is conditional
on the network link, for example checking some attribute of its network neighbors and responding
accordingly. Given that <code>B2</code> is on a different process there is no way for <code>A1</code> to
query <code>B2</code>. However, the bottom part of the figure shows how ghost agents are used to tie the network together. <code>B2</code> is
copied to process 1 where a local link is created between it and <code>A1</code>. <code>A1</code> can now query the state of <code>B2</code>.
Similarly, a ghost of <code>A1</code> is copied to process 2 where <code>B2</code> can now interact with it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The copying and synchronization of ghosts agent and ghost agent state is performed by Repast4Py. The
user only needs to provide a minimal amount of code to handle the saving and restoring of agent state. This
is described in more detail in subsequent sections.
</td>
</tr>
</table>
</div>
<div id="img-network-ghost" class="imageblock">
<div class="content">
<img src="images/shared_net_2.png" alt="shared net 2">
</div>
<div class="title">Figure 1. Ghost Agents in a Shared Network</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do not update the state of non-local ghost agents. They only exist to be <em>seen</em> by
local agents and objects. Any state changes to any agent must be performed on the agent&#8217;s
local process. The SharedContext component makes a clear distinction between the two types
of agents, allowing you to work with only the local agents.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spatial projections such as a grid or continuous space are stitched together through the use of
<strong><em>buffers</em></strong> and ghosts agents.</p>
</div>
<div id="img-grid-buffer" class="imageblock">
<div class="content">
<img src="images/shared_grid_agents_800.png" alt="shared grid agents 800">
</div>
<div class="title">Figure 2. Ghost Agents in a Buffered Area</div>
</div>
<div class="paragraph">
<p>This is illustrated in <a href="#img-grid-buffer">Figure 2</a>, where the full 6x8 grid is distributed across 4 process ranks. Each rank is responsible for
its own 3x4 quarter of the global grid (left hand side of <a href="#img-grid-buffer">Figure 2</a>).
On the right hand side, we see how the quarters are stitched together. Each subsection
of the grid contains a buffer that is a copy of the contents of the adjacent subsections.
The blue part of the image is the area for process 1&#8217;s grid subsection. There, we can
see the ghost agents <code>C3</code> and <code>B2</code> copied from processes 3 and 2 respectively. In this way,
agent <code>A1</code> can <em>see</em> and interact with agents <code>C3</code> and <code>B2</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Be sure to specify a buffer size appropriate for agent behavior. For example, if an agent can see 3 units away and take some action based on what it perceives, then the buffer size should be at least 3, ensuring that an agent can properly see beyond the borders of its own local area.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Agents can, of course, move around grids and continuous spaces. When an agent moves beyond the borders of its local subsection then it is moved from that rank to the rank of the new subsection to which it has moved. For example, if in <a href="#img-grid-buffer">Figure 2</a>, agent <code>D4</code> moves from grid coordinate 4,4 to 4,2 then it will be moved during Repast4Py&#8217;s synchronization phase to process 2 where it becomes local
to that process. Cross-process movement and synchronization will be discussed more in the next sections.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When working with Repast4Py&#8217;s <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedCSpace">continuous space</a> (an N-dimensional cartesian space where agents can occupy locations defined by a continuous floating point coordinate), use the <code>tree_threshold</code> parameter to tune
the speed of the search for agents within the buffered area. This search occurs whenever the buffer is refreshed
during synchronization. The continuous space uses a <a href="https://en.wikipedia.org/wiki/Quadtree">tree</a> (quad or oct depending on the number of dimensions) to efficiently determine which agents are within the buffered region.
Each node in the tree represents an area of the continuous space and contains the point locations of agents within that area. A spatial query, such as that used to find agents in the buffered region, first determines which nodes of the
tree intersect the queried area, and then which points / agents in those nodes intersect the queried area. In this way,
the buffer&#8217;s spatial query does not have to iterate through all the occupied points in a continuous space, a potentially time
consuming operation, when updating the buffer areas. The <code>tree_threshold</code> parameter specifies the maximum number of unique points in a spatial index tree node. When this number is reached, the node splits and the points are redistributed among the node&#8217;s children. When specifing a <code>tree_threshold</code>, the intention is to lower the number of points / agents that need to be evaluated in a spatial query while balancing that against the overhead it takes to split the tree nodes. A value of 100 is probably a reasonable starting point, but experimenting with different values is encouraged.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cross_process_code_requirements">4. Cross-Process Code Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve seen in the <a href="#_distributed_simulation">Distributed Simulation</a> section how ghost agents
(non-local copies) are used
to stitch a simulation together across processes and that when agents move out of their local
grid or continuous space subsection they are moved to the process responsible for the destination
subsection. While much of this is handled internally by Repast4Py, this section describes in more detail the
code the user needs to provide in order for moving and copying to work correctly. We will use examples from the Zombies and Rumor demonstration models. See the <a href="https://repast.github.io/repast4py.site/examples/examples.html">Repast4Py Examples</a> page to download the source code for these models and for more information on getting started with the examples.</p>
</div>
<div class="sect2">
<h3 id="_agent_id">4.1. Agent ID</h3>
<div class="paragraph">
<p>For moving and copying agents across processes to work each agent must have a unique id.
This id has three components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An integer that uniquely identifies the agent on the rank on which it was created</p>
</li>
<li>
<p>An integer that identifies its type</p>
</li>
<li>
<p>The integer rank on which the agent was created</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Combining the first component with the last allows us to uniquely identify an agent across the multi-process
simulation while the second allows us to create agents of the appropriate type when they are copied
between ranks.</p>
</div>
<div class="paragraph">
<p>In order to ensure that all agents in Repast4Py have an agent id, all agents must inherit from the
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a> class which requires these components in its constructor. For example, in the
Zombies demonstration model, the <code>Human</code> agents are subclasses of the <code>repast4py.core.Agent</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Human</span><span class="tok-p">(</span><span class="tok-n">repast4py</span><span class="tok-o">.</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-sd">&quot;&quot;&quot;The Human Agent</span>

<span class="tok-sd">    Args:</span>
<span class="tok-sd">        a_id: a integer that uniquely identifies this Human on its</span>
<span class="tok-sd">              starting rank</span>
<span class="tok-sd">        rank: the starting MPI rank of this Human.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>

    <span class="tok-n">ID</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">a_id</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">a_id</span><span class="tok-p">,</span> <span class="tok-nb">type</span><span class="tok-o">=</span><span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Human inherits from <code>repast4py.core.Agent</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calling the <code>repast4py.core.Agent</code> constructor with the agent id
components.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The components as well as the full unique id are accessible as
attributes of the <code>repast4py.core.Agent</code> class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>id: the id component from the agent&#8217;s unique id</p>
</li>
<li>
<p>type: the type component from the agent&#8217;s unique id</p>
</li>
<li>
<p>rank: the rank component from the agent&#8217;s unique id</p>
</li>
<li>
<p>uid: the unique id tuple (id, type, rank)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><pre><span></span><span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">Human</span><span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">3</span><span class="tok-p">)</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">id</span>
<span class="tok-mi">12</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">rank</span>
<span class="tok-mi">4</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">type</span>
<span class="tok-mi">0</span>
<span class="tok-o">&gt;&gt;&gt;</span> <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">uid</span>
<span class="tok-p">(</span><span class="tok-mi">12</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">4</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All agents must subclass <code>repast4py.core.Agent</code>. See the <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent">API documenation</a> for <code>repast4py.core.Agent</code> for more details of the <code>Agent</code> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_saving_and_restoring_agents">4.2. Saving and Restoring Agents</h3>
<div class="paragraph">
<p>Moving or copying an agent between processes consists of saving the agent state, moving / copying that state
to another process, and then restoring the agent state as an agent on the destination process. For this to work, each
agent is required to implement a <code>save</code> method that returns a tuple containing the full agent state. The first element of this
full state tuple is the agent&#8217;s unique id, itself a tuple (accessed via the <code>uid</code> attribute), and the second
is the dynamic state of that agent. For example, in the Zombie
demonstration model the state of each Human is represented by two variables:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>infected: a boolean that indicates whether or not the Human is infected</p>
</li>
<li>
<p>infected_duration: an integer tracking how long the agent has been infected</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>save</code> method creates a tuple consisting of these two variables and the unique id tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">Tuple</span><span class="tok-p">:</span>
        <span class="tok-sd">&quot;&quot;&quot;Saves the state of this Human as a tuple.</span>

<span class="tok-sd">        Used to move this Human from one MPI rank to another.</span>

<span class="tok-sd">        Returns:</span>
<span class="tok-sd">            The saved state of this Human.</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected_duration</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The agent state in the tuple returned from <code>save</code> can also consist of other tuples, lists
and so on, in addition to primitive values, as long as the unique id tuple is the first element.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All agents must implement a <code>save</code> method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You must also provide a <code>restore</code> function that takes the tuple produced by the <code>save</code> method and
returns an agent either created from or updated with that state. The function is used during synchronization
to create the agents on the destination ranks. In the Zombies demonstration model, the <code>restore_agent</code>
function, when given agent state, returns Human and Zombie agents. It uses a caching scheme
to avoid re-instantiating agents that have previously been created on a rank, and updates the
state of those previously created agents. This can be a useful performance improvement at the
expense of using more memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><pre><span></span><span class="tok-n">agent_cache</span> <span class="tok-o">=</span> <span class="tok-p">{}</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-k">def</span> <span class="tok-nf">restore_agent</span><span class="tok-p">(</span><span class="tok-n">agent_data</span><span class="tok-p">:</span> <span class="tok-n">Tuple</span><span class="tok-p">):</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-sd">&quot;&quot;&quot;Creates an agent from the specified agent_data.</span>

<span class="tok-sd">    This is used to re-create agents when they have moved from one MPI rank</span>
<span class="tok-sd">    to another. The tuple returned by the agent&#39;s save() method is moved</span>
<span class="tok-sd">    between ranks and create_agent is called for each tuple in order</span>
<span class="tok-sd">    to create the agent on that rank. Here we also use</span>
<span class="tok-sd">    a cache to store any agents already created on this rank,</span>
<span class="tok-sd">    and only update their state rather than recreating them from scratch.</span>

<span class="tok-sd">    Args:</span>
<span class="tok-sd">        agent_data: the data from which to create the agent. This is the tuple</span>
<span class="tok-sd">                    returned from the agent&#39;s save() method where the first</span>
<span class="tok-sd">                    element is the agent id tuple, and any remaining</span>
<span class="tok-sd">                    arguments encapsulate agent state.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">agent_data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>                                         <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-c1"># in uid element 0 is id, 1 is type, 2 is rank</span>
    <span class="tok-k">if</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">:</span>                                      <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">if</span> <span class="tok-n">uid</span> <span class="tok-ow">in</span> <span class="tok-n">agent_cache</span><span class="tok-p">:</span>                                  <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">agent_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">Human</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">])</span>
            <span class="tok-n">agent_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">h</span>

        <span class="tok-c1"># restore the agent state from the agent_data tuple</span>
        <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">infected</span> <span class="tok-o">=</span> <span class="tok-n">agent_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>                              <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">infected_duration</span> <span class="tok-o">=</span> <span class="tok-n">agent_data</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span>
        <span class="tok-k">return</span> <span class="tok-n">h</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>                                                       <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-c1"># note that the zombie has no internal state</span>
        <span class="tok-c1"># so there&#39;s nothing to restore other than</span>
        <span class="tok-c1"># the Zombie itself</span>
        <span class="tok-k">if</span> <span class="tok-n">uid</span> <span class="tok-ow">in</span> <span class="tok-n">agent_cache</span><span class="tok-p">:</span>
            <span class="tok-k">return</span> <span class="tok-n">agent_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-n">Zombie</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">])</span>
            <span class="tok-n">agent_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">z</span>
            <span class="tok-k">return</span> <span class="tok-n">z</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cache for previously instantiated agents. Key is an agent&#8217;s unique id (uid) tuple and value is the agent.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>agent_data</code> is a tuple of the format produced by the <code>save</code> method. For Humans this is (uid, infected,
infected_duration). For Zombies, this is just (uid).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first element of the <code>agent_data</code> tuple is the uid tuple. The uid tuple is (id, type, starting rank).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Checks if the agent is a Human or Zombie, using the type component of the uid.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Checks if the agent is already cached, if so then get it (line 23), otherwise create a new <code>Human</code> agent
(line 25).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Updates the cached / created Human with the passed in agent state.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>agent_data</code> is for a Zombie so search cache and if necessary create a new one.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lastly, in a distributed network, agents are not typically moved between processes
but rather the ghost agents remain on a process once the network is created. Repast4Py tracks
these ghost agents and does not recreate the agents every synchronization step via a <code>restore</code>
method, instead a state update is sent to the appropriate ghost agents. In that case, an agent&#8217;s <code>update</code>
method is called to handle the state update. The Rumor demonstration model has an example of this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">RumorAgent</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>

    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">update</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">:</span> <span class="tok-nb">bool</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-sd">&quot;&quot;&quot;Updates the state of this agent when it is a ghost</span>
<span class="tok-sd">        agent on some rank other than its local one.</span>

<span class="tok-sd">        Args:</span>
<span class="tok-sd">            data: the new agent state (received_rumor)</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-o">...</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-o">=</span> <span class="tok-n">data</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Updates ghost agent state from saved agent state. Here the <code>data</code> argument
is only the dynamic state element of the tuple returned from the agent&#8217;s <code>save</code> method, namely,
the <code>self.received_rumor</code> bool from <code>(self.uid, self.received_rumor)</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization">4.3. Synchronization</h3>
<div class="paragraph">
<p>As mentioned in the <a href="#_distributed_simulation">Distributed Simulation</a> section, each process in a
Repast4Py application runs in a separate memory space from all the other processes. Consequently,
we need to synchronize the model state across processes by moving agents, filling
projection buffers with ghosts, and updating ghosted states, as necessary. Synchronization
is performed by calling the
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.context.html#repast4py.context.SharedContext.synchronize"><code>SharedContext.synchronize</code></a>method and passing it your restore function.
The <code>synchronization</code> method will use the agent <code>save</code> method(s) and your restore function
to synchronize the state of the simulation across its processes.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_1_a_simple_random_walk_model">5. Tutorial 1 - A Simple Random Walk Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial will guide you through coding a simple model, focusing on components
and concepts common to every model. The simulation itself consists of a number
of agents moving at random around a two-dimensional grid and logging the aggregate and agent-level
colocation counts. Each timestep the following occurs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All the agents (<em>walkers</em>) choose a random direction and move one unit in that direction.</p>
</li>
<li>
<p>All the agents count the number of other agents they <em>meet</em> at their current location by
determining the number of colocated agents at their grid locations.</p>
</li>
<li>
<p>The sum, minimum, and maxiumum number of agents met are calculated across all process ranks, and these
values are logged as the total, minimum, and maximum <code>meet</code> values.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In addition, every 10 timesteps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The individual agent <em>meet</em> counts are logged across all the process ranks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See the <a href="https://repast.github.io/repast4py.site/examples/examples.html">Repast4Py Examples</a> page to download the source code for this model
and for more information on getting started with the examples.</p>
</div>
<div class="paragraph">
<p>The code consists of the following components:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>Walker</code> class that implements the agent state and behavior.</p>
</li>
<li>
<p>A <code>Model</code> class responsible for initialization and managing the simulation.</p>
</li>
<li>
<p>A <code>restore_walker</code> function used to create an individual <code>Walker</code> when that
<code>Walker</code> has moved (i.e., walked) to another process.</p>
</li>
<li>
<p>A <code>run</code> function that creates and starts the simulation.</p>
</li>
<li>
<p>An <code>if <em>name</em> == "<em>main</em>"</code> block that allows the simulation to be run
from the command line.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is the canonical way to organize a Repast4Py simulation: agents implemented as classes,
a <em>model</em>-type class to initialize and manage the simulation, a function to handle restoring agents
as they move between processes, and some additional code to run the simulation from the command line. O
f course, in a more complex simulation the responsibilities and behavior of the agent and model classes can be
factored out into additional classes, functions, and modules as necessary, but the overall
organization remains the same.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_the_walker_agent">5.1. The Walker Agent</h3>
<div class="paragraph">
<p>The Walker class implements our Walker agent, encapsulating its:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>State: a count of all the other walkers that it has colocated with, and the walker&#8217;s current location</p>
</li>
<li>
<p>Behavior: moving randomly around a 2D dimensional grid and counting the number
of colocations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As required for all Repast4Py agent implementations, the <code>Walker</code> class subclasses
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a>, passing it the components of the unique agent id tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">DiscretePoint</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span>
<span class="tok-kn">import</span> <span class="tok-nn">numpy</span> <span class="tok-k">as</span> <span class="tok-nn">np</span>

<span class="tok-k">class</span> <span class="tok-nc">Walker</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>   <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">TYPE</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">OFFSETS</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">array</span><span class="tok-p">([</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">])</span>    <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">local_id</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-p">:</span> <span class="tok-n">DiscretePoint</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">local_id</span><span class="tok-p">,</span> <span class="tok-nb">type</span><span class="tok-o">=</span><span class="tok-n">Walker</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">pt</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Walker subclasses <code>repast4py.core.Agent</code>. Subclassing <code>Agent</code> is a requirement for all Repast4Py agent implementations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TYPE</code> is a class variable that defines an agent type id for our walker agent. This is a required
part of the unique agent id tuple (see 4).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>OFFSETS</code> is a numpy array used in the agent behavior implementation to select the direction to move in. See the discussion of the <code>walk</code> method below.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>repast4py.core.Agent</code> constructor takes 3 arguments: an integer id that uniquely identifes an
agent on the process where it was created, a non-negative integer identifying the type of the agent, and
the rank on which the agent is created. Taken together, these three uniquely identify the agent
across all ranks in the simulation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The agent&#8217;s behavior is implemented in the <code>walk</code> and the <code>count_colocations</code> methods.
In the <code>walk</code> method, the agent randomly chooses an offset from its current location (<code>self.pt</code>),
adds those offsets to its current location to create a new location, and then moves to that new
location on the grid. The moved-to-location becomes the agent&#8217;s new current location.</p>
</div>
<div class="sect3">
<h4 id="_walking_the_walker">5.1.1. Walking the Walker</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">random</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">DiscretePoint</span>
<span class="tok-o">...</span>
<span class="tok-n">OFFSETS</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">array</span><span class="tok-p">([</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
<span class="tok-o">...</span>
<span class="tok-k">def</span> <span class="tok-nf">walk</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">grid</span><span class="tok-p">:</span> <span class="tok-n">SharedGrid</span><span class="tok-p">):</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-c1"># choose two elements from the OFFSET array</span>
    <span class="tok-c1"># to select the direction to walk in the</span>
    <span class="tok-c1"># x and y dimensions</span>
    <span class="tok-n">xy_dirs</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">choice</span><span class="tok-p">(</span><span class="tok-n">Walker</span><span class="tok-o">.</span><span class="tok-n">OFFSETS</span><span class="tok-p">,</span> <span class="tok-n">size</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">DiscretePoint</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">xy_dirs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span>
                        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">y</span> <span class="tok-o">+</span> <span class="tok-n">xy_dirs</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">))</span> <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>repast4py.random</code> contains an instance of a <code>numpy.random.Generator</code> as the module level variable
<code>default_rng</code>, as well as a function for intializing this variable. See the numpy <a href="https://numpy.org/doc/stable/reference/random/generator.html">random.Generator</a> api reference for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All the walker agents move on the same grid. An instance of this grid, a <code>repast4py.space.SharedGrid</code> object is passed in.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://numpy.org/doc/stable/reference/random/generated/numpy.random.Generator.choice.html#numpy.random.Generator.choice"><code>numpy.random.Generator.choice</code></a> randomly chooses <code>size</code> number of elements
from a numpy array. In this case randomly selecting either -1 or 1 from <code>OFFSETS</code>. The
two chosen values correspond to the direction to move along the x and y dimensions, respectively.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>SharedGrid.move</code> moves an agent to a location in the grid and returns the destination location. Grid locations are represented by a <code>repast4py.space.DiscretePoint</code> and an instance of
that with updated new x and y coordinates is passed to the <code>move</code> method.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Repast4Py provides a default random number generator in <code>repast4py.random.default_rng</code>. This
random number generator is initialized when the module is imported, with the current time as the seed.
The seed can also be set by specifying a <code>random.seed</code> model input parameter and using Repast4Py&#8217;s model input parameters utility code. (See <a href="#_running_the_simulation">Running the Simulation</a> for more details.) <code>random.default_rng</code> is an instance of <code>numpy.random.Generator</code>. See the numpy <a href="https://numpy.org/doc/stable/reference/random/generator.html">random.Generator</a> api reference for more information on the available distributions and sampling functions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_logging_the_walker">5.1.2. Logging the Walker</h4>
<div class="paragraph">
<p>The <code>count_colocations</code> method gets the number of other agents at the current location, and
updates both the agent&#8217;s individual running total of other agents met, as well as a <code>MeetLog</code> dataclass
instance that is used to log the total number of meets and the minimum and maximum.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">MeetLog</span><span class="tok-p">:</span>
    <span class="tok-n">total_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-n">min_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-n">max_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-o">...</span>

<span class="tok-k">def</span> <span class="tok-nf">count_colocations</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">grid</span><span class="tok-p">:</span> <span class="tok-n">SharedGrid</span><span class="tok-p">,</span> <span class="tok-n">meet_log</span><span class="tok-p">:</span> <span class="tok-n">MeetLog</span><span class="tok-p">):</span>
    <span class="tok-c1"># subtract self</span>
    <span class="tok-n">num_here</span> <span class="tok-o">=</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_num_agents</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span><span class="tok-p">)</span> <span class="tok-o">-</span> <span class="tok-mi">1</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">total_meets</span> <span class="tok-o">+=</span> <span class="tok-n">num_here</span>
    <span class="tok-k">if</span> <span class="tok-n">num_here</span> <span class="tok-o">&lt;</span> <span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">min_meets</span><span class="tok-p">:</span>
        <span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">min_meets</span> <span class="tok-o">=</span> <span class="tok-n">num_here</span>
    <span class="tok-k">if</span> <span class="tok-n">num_here</span> <span class="tok-o">&gt;</span> <span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">max_meets</span><span class="tok-p">:</span>
        <span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">max_meets</span> <span class="tok-o">=</span> <span class="tok-n">num_here</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_count</span> <span class="tok-o">+=</span> <span class="tok-n">num_here</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>SharedGrid.get_num_agents</code> returns the number of agents at a specified location.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn more about built-in agent and grid functionality, see the
API documentation for <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a>
and <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid"><code>repast4py.space.SharedGrid</code></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As we will see below, the Model class will schedule the execution of these two functions on every agent at every timestep. In this way, each agent executes its behavior each timestep.</p>
</div>
</div>
<div class="sect3">
<h4 id="_serializing_the_walker">5.1.3. Serializing the Walker</h4>
<div class="paragraph">
<p>When a <code>Walker</code> walks beyond the bounds of the local grid managed by its current
process rank, or when populating the buffer area of the local grid sections,
Repast4Py needs to serialize the <code>Walker</code> state to a tuple, which is then used
to recreate that <code>Walker</code> on a different process. The <code>Walker.save</code> method
performs this serialization, saving the agent&#8217;s unique id, its current meet count,
and location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">Tuple</span><span class="tok-p">:</span>
    <span class="tok-sd">&quot;&quot;&quot;Saves the state of this Walker as a Tuple.</span>

<span class="tok-sd">    Returns:</span>
<span class="tok-sd">        The saved state of this Walker.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_count</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">coordinates</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns the <code>Walker</code> state as a tuple. The first element of this
tuple <strong>MUST</strong> be the agent&#8217;s unique id (<code>self.uid</code>). <code>self.pt</code> is
an instance of a <code>DiscretePoint</code> whose <code>coordinates</code> method
returns the point&#8217;s coordinates as a numpy array.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Every agent must implement a <code>save</code> method that returns the
state of the agent as a tuple. The first element of this
tuple <strong>MUST</strong> be the agent&#8217;s unique id (<code>self.uid</code>). The remaining elements
should encapsulate any dynamic agent state.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_model_class">5.2. The Model Class</h3>
<div class="paragraph">
<p>The Model class encapsulates the simulation and is responsible for initialization. It schedules events,
creates agents and the grid the agents inhabit, and manages logging. In addition, the scheduled events
that drive the simulation forward are methods of the <code>Model</code> class.</p>
</div>
<div class="paragraph">
<p>In the <code>Model</code> constructor, we create the simulation schedule, the context that holds
our agents, the grid on which they move, the agents themselves, and the loggers that
we use to log various simulation statistics to files. We begin with the constructor
signature, and the schedule runner creation.</p>
</div>
<div class="sect3">
<h4 id="_scheduling_events_2">5.2.1. Scheduling Events</h4>
<div class="paragraph">
<p>The SharedScheduledRunner class encapsulates a dynamic schedule of executable events shared and
synchronized across processes. Events are added to the schedule for execution at a particular <em>tick</em>.
The first valid tick is 0. Events will be executed in tick order, earliest before latest.
When multiple events are scheduled for the same tick, the events' priorities
will be used to determine the order of execution within that tick. If during the
execution of a tick, an event is scheduled before the executing tick (i.e., scheduled to occur in the past) then
that event is ignored. The schedule is synchronized across process ranks
by determining the global cross-process minimum next scheduled event time and executing events
for that time. In this way, no schedule runs ahead of any other. In practice an
event is a Python function or method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">:</span> <span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">Intracomm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-c1"># create the schedule</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span> <span class="tok-o">=</span> <span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">init_schedule_runner</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>     <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_repeating_event</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">step</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_repeating_event</span><span class="tok-p">(</span><span class="tok-mf">1.1</span><span class="tok-p">,</span> <span class="tok-mi">10</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">log_agents</span><span class="tok-p">)</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_stop</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;stop.at&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-c1"># once initialized the schedule runner can be accessed with schedule.runner</span>
    <span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-n">schedule_end_event</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">at_end</span><span class="tok-p">)</span>    <i class="conum" data-value="5"></i><b>(5)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Model constructor takes an MPI communicator and a dictionary of model
input parameters as arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Before any events can be scheduled, the schedule runner must be initialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Schedules <code>Model.step</code> on this instance of the model to execute starting at tick 1 and then every
tick thereafter. Repeating events are scheduled with <code>schedule.repeating_event</code>. The first argument
is the start tick, and the second is the frequency for repeating.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>schedule_stop</code> schedules the tick at which the simulation should stop. At this tick,
events will no longer be popped off the schedule and executed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>schedule_end_event</code> can be used to schedule methods that perform some sort of
<em>clean up</em> type operation when the simulation ends, closing a log file, for example.
This is called at the time specified in the call to <code>schedule_stop</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once the default scheduler runner has been initialized with <code>schedule.init_schedule_runner</code>, you can get a reference to it with <code>schedule.runner()</code>. See the schedule module
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.schedule.html">API documentation</a> for
more information on different ways to schedule events (methods and functions).
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A simulation stopping time must be set with <code>schedule_stop</code>. Without a stopping time
the simulation will continue to run, seeming to hang if there are no events to execute, or
continuing to execute any scheduled events without stopping. The stopping time does not
need to be set during initialization, but can be set during a simulation run when a
stopping condition is reached.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default events are scheduled with a random priority type, meaning that
events scheduled for the same tick will be executed in random order. Other
priority types are available though:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PriorityType.FIRST</code> - events will execute before those with other PriorityTypes.
All events with a <code>FIRST</code> priority type will execute in the order in which they are scheduled
with respect to other <code>FIRST</code> priority type events.</p>
</li>
<li>
<p><code>PriorityType.RANDOM</code> - events will execute in a random order, after the <code>FIRST</code>
priority type events, and before the <code>LAST</code> priority type events. If there are <code>BY_PRIORITY</code>
events scheduled for the same tick as <code>RANDOM</code> events, the <code>RANDOM</code> events will be shuffled at
random into the ordered <code>BY_PRIORITY</code> events.</p>
</li>
<li>
<p><code>PriorityType.BY_PRIORITY</code> - events will execute in the order specified by an additional
priority parameter (lower values are higher priority), and after any <code>FIRST</code> priority events
and before any <code>LAST</code> priority events. If there are <code>RANDOM</code> priority events scheduled
for the same tick as <code>BY_PRIORITY</code> events, those will be shuffled at random into the
ordered <code>BY_PRIORITY</code> events.</p>
</li>
<li>
<p><code>PriorityType.LAST</code> - events will execute after those with other priority types.
All events with a <code>LAST</code> priority type will execute in the order in which they are scheduled
with respect to other <code>LAST</code> priority type events.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An event&#8217;s <code>PriorityType</code> and optional <code>priority</code> can specified via the scheduling methods (e.g.,
<code>schedule_repeating_event</code>). See the schedule module
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.schedule.html">API documentation</a> for
more information on different ways to schedule events (methods and functions).</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_context_and_grid">5.2.2. Creating the Context and Grid</h4>
<div class="paragraph">
<p>Once the schedule has been initialized and events have been added, the context, which holds the population of agents, and the grid projection on which the agents move are
created (contexts and projections are described in <a href="#_contexts_and_projections">Contexts and Projections</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">context</span> <span class="tok-k">as</span> <span class="tok-n">ctx</span>
<span class="tok-o">...</span>

<span class="tok-c1"># create the context to hold the agents and manage cross process</span>
<span class="tok-c1"># synchronization</span>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-n">SharedContext</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># create a bounding box equal to the size of the entire global world grid</span>
<span class="tok-n">box</span> <span class="tok-o">=</span> <span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">BoundingBox</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;world.width&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;world.height&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1"># create a SharedGrid of &#39;box&#39; size with sticky borders that allows multiple agents</span>
<span class="tok-c1"># in each grid location.</span>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span> <span class="tok-o">=</span> <span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">SharedGrid</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-o">=</span><span class="tok-s1">&#39;grid&#39;</span><span class="tok-p">,</span> <span class="tok-n">bounds</span><span class="tok-o">=</span><span class="tok-n">box</span><span class="tok-p">,</span> <span class="tok-n">borders</span><span class="tok-o">=</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">BorderType</span><span class="tok-o">.</span><span class="tok-n">Sticky</span><span class="tok-p">,</span>
                                <span class="tok-n">occupancy</span><span class="tok-o">=</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">OccupancyType</span><span class="tok-o">.</span><span class="tok-n">Multiple</span><span class="tok-p">,</span>
                                <span class="tok-n">buffer_size</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-o">=</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add_projection</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates the <a href="#_contexts_and_projections"><code>SharedContext</code></a> for this
simulation. The <code>SharedContext</code> contains the population of agents and manages
synchronization of the projections across ranks.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A BoundingBox is used to initialize the size of Repast4Py&#8217;s cartesian spaces. Its
arguments are the minimum x coordinate, the extent of the x dimension, and then the same for
the y and z dimensions. Here we create a 2D box (the z extent is 0) starting at (0,0) and
extending for <code>params['world.width]</code> in the x dimension and <code>params['world.height']</code> in
the y dimension.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>space.SharedGrid</code> takes a name, its bounds, its border, and occupancy types, as well
as a buffer size, and a communicator as arguments. See the <code>SharedGrid</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid">API documentation</a>
for a description of these arguments. The concept of a buffer was described in the
<a href="#_distributed_simulation">Distributed Simulation</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Once a <a href="#_contexts_and_projections">projection</a> has been created
it must be added to the context so that it can be properly synchronized across
processes.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_agents">5.2.3. Creating the Agents</h4>
<div class="paragraph">
<p>When creating the agents, we create the number of Walker agents specified in the <code>walker.count</code>
input parameter, assigning each a random location.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-n">rank</span> <span class="tok-o">=</span> <span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_rank</span><span class="tok-p">()</span>
<span class="tok-k">for</span> <span class="tok-n">i</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;walker.count&#39;</span><span class="tok-p">]):</span>
    <span class="tok-c1"># get a random x,y location in the grid</span>
    <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_random_local_pt</span><span class="tok-p">(</span><span class="tok-n">rng</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-c1"># create and add the walker to the context</span>
    <span class="tok-n">walker</span> <span class="tok-o">=</span> <span class="tok-n">Walker</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">walker</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">walker</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-p">)</span>  <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets random location within the grid&#8217;s local bounds. Each rank is responsible for some subsection of the
total global grid and <code>get_random_local_pt</code> gets a random location within those local bounds.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates the Walker, passing it an id, its starting rank, and its current location. See
<a href="#_the_walker_agent">Section 5.1, &#8220;The Walker Agent&#8221;</a> for more.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Adds the new Walker to the context. Once created, an agent must be added to the context in order to be properly synchronized
and iterated through as part of the agent population.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Move the walker to its starting location.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Agents added to a context are also added to any projections in that context. Although
projections have <code>add</code> methods for adding agents, these are typically <em>NOT</em> used in a
simulation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_initializing_logging">5.2.4. Initializing Logging</h4>
<div class="paragraph">
<p>Logging refers to gathering simulation output data and writing it to a file. There are
two types of logging supported by Repast4Py.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Tabular logging in which the user supplies row values to be logged, and Repast4Py
concatenates these rows across processes and writes them to a file. This is useful
for logging events and individual agent attributes. See the <code>repast4py.logging.TabularLogger</code>
API for more information.</p>
</li>
<li>
<p>Reduce-type logging where the user supplies the aggregate values to be logged
in the form of a Python <code>dataclasses.dataclass</code> and Repast4Py performs a cross-process
reduce-type (e.g., summation) operation on those values. To use this
type of logging, you create a <em>logger</em>, which is responsible for logging the dataclass field(s)
and performing the reduction operation on the field(s). These loggers are then added to
a <code>logging.ReducingDataSet</code>. Calling <code>logging.ReducingDataSet.log(tick)</code> will log the
current value of the dataclass field(s) in the loggers and perform the cross-process
reduction. See the <code>logging</code> module
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.logging.html">API documentation</a> for more information.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Walker Model uses both of these logging types. The first is used to log the individual <em>meet_count</em> of
each agent, and the second to log that total number of meets, as well as the minimum and maximum number.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">MeetLog</span><span class="tok-p">:</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">total_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-n">min_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-n">max_meets</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>

<span class="tok-o">...</span>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">agent_logger</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">TabularLogger</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;agent_log_file&#39;</span><span class="tok-p">],</span>
                                          <span class="tok-p">[</span><span class="tok-s1">&#39;tick&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;agent_id&#39;</span><span class="tok-p">,</span> <span class="tok-s1">&#39;agent_uid_rank&#39;</span><span class="tok-p">,</span>
                                          <span class="tok-s1">&#39;meet_count&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span> <span class="tok-o">=</span> <span class="tok-n">MeetLog</span><span class="tok-p">()</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">loggers</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">create_loggers</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-p">,</span> <span class="tok-n">op</span><span class="tok-o">=</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">SUM</span><span class="tok-p">,</span>
                                 <span class="tok-n">names</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">&#39;total_meets&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;total&#39;</span><span class="tok-p">},</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-n">loggers</span> <span class="tok-o">+=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">create_loggers</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-p">,</span> <span class="tok-n">op</span><span class="tok-o">=</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">MIN</span><span class="tok-p">,</span>
                                  <span class="tok-n">names</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">&#39;min_meets&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;min&#39;</span><span class="tok-p">},</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span>       <i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-n">loggers</span> <span class="tok-o">+=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">create_loggers</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-p">,</span> <span class="tok-n">op</span><span class="tok-o">=</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">MAX</span><span class="tok-p">,</span>
                                  <span class="tok-n">names</span><span class="tok-o">=</span><span class="tok-p">{</span><span class="tok-s1">&#39;max_meets&#39;</span><span class="tok-p">:</span> <span class="tok-s1">&#39;max&#39;</span><span class="tok-p">},</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span>       <i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">ReducingDataSet</span><span class="tok-p">(</span><span class="tok-n">loggers</span><span class="tok-p">,</span> <span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-p">,</span>
                                        <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;meet_log_file&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="7"></i><b>(7)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>MeetLog is the dataclass used by the aggregate reduce logging. As we saw in
<a href="#_logging_the_walker">Section 5.1.2, &#8220;Logging the Walker&#8221;</a> each agent updates the shared MeetLog instance as appropriate in
its <code>count_colocations</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>TabularLogger</code> class is used for tabular-style logging. The constructor
arguments are the communicator over which to concatenate all the table&#8217;s rows and
the column header values. <code>self.agent_logger</code> is then used to log the individual
agent meet counts.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates the <code>MeetLog</code> object that contains the aggregate colocation statistics
that we want to log.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creates a logger that uses <code>self.meet_log</code> as the source of the data to log,
performing a cross process summation (<code>op=MPI.SUM</code>) of that data to log, and logs the value
of the <code>total</code> field in <code>self.meet_log</code>. The <code>names</code> argument specifies
the fields to log as a dictionary where the key is the dataclass field to log, and
the value is the column header text for that value.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creates a logger for the <code>self.meet_log.min</code> field, minimizing the value
across processes. The created logger is added to the list of loggers created
in 4.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Creates a logger for the <code>self.meet_log.max</code> field, maximizing the value
across processes. The created logger is added to the list of loggers created
in 4.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Creates a <code>logging.ReducingDataSet</code> from the list of loggers. <code>params['meet_log_file]</code>
is the name of the file to log to.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After the logging is initialized, we log the starting tick 0 state of the
simulation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c1"># count the initial colocations at time 0 and log</span>
<span class="tok-k">for</span> <span class="tok-n">walker</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">():</span>
    <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">count_colocations</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">max_meets</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">min_meets</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">total_meets</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>   <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">log_agents</span><span class="tok-p">()</span>    <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Updates <code>self.meet_log</code> with each agents colocation data by calling <code>count_colocations</code>
on each agent. See <a href="#_logging_the_walker">Section 5.1.2, &#8220;Logging the Walker&#8221;</a> for the details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Logs the current values of the <code>self.meet_log</code> by calling <code>log</code> on the <code>self.data_set</code> <code>ReducingDataSet</code>.
The <code>log</code> method takes a floating point argument that specifies the tick at which the data was logged (in this case tick 0).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Resets the <code>self.meet_log</code> values back to 0 given that we want to log the data per tick, rather than a running total.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Logs the individual agent meet counts. See the method definition below.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>log_agents</code> method logs each agent&#8217;s <code>meet_count</code> using the
<code>self.agent_logger TabularLogger</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">log_agents</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">tick</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">tick</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">for</span> <span class="tok-n">walker</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">():</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">agent_logger</span><span class="tok-o">.</span><span class="tok-n">log_row</span><span class="tok-p">(</span><span class="tok-n">tick</span><span class="tok-p">,</span> <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">id</span><span class="tok-p">,</span> <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">uid_rank</span><span class="tok-p">,</span>
                                  <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">meet_count</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">agent_logger</span><span class="tok-o">.</span><span class="tok-n">write</span><span class="tok-p">()</span>   <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets the current tick value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Iterates over all the local agents in the context. <code>SharedContext.agents()</code> returns
an iterator over the local agent population.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For each Walker, log the current tick, the Walker&#8217;s id, its unique id rank,
and its <code>meet_count</code> using the <code>log_row</code> method. Each call to <code>log_row</code> becomes
a row in the tabular output.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Writes the currently logged rows to a file. It is not strictly necessary
to call <code>write</code> every time rows are logged as the rows will accumulate until <code>write</code>
is eventually called.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_scheduled_methods">5.2.5. Scheduled Methods</h4>
<div class="paragraph">
<p>In <a href="#_scheduling_events">Section 3.2, &#8220;Scheduling Events&#8221;</a> we saw how to schedule events that repeat and that execute
when the simulation ends. In this model, the events to be scheduled are methods of the
<code>Model</code> class. The methods are called according to how they are scheduled, driving the
simulation forward. The first of these, the <code>step</code> method, is scheduled to execute starting
at tick 1 and then every tick thereafter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c1"># scheduled with: self.runner.schedule_repeating_event(1, 1, self.step)</span>
<span class="tok-k">def</span> <span class="tok-nf">step</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-k">for</span> <span class="tok-n">walker</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">():</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">walk</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-p">)</span>

    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">synchronize</span><span class="tok-p">(</span><span class="tok-n">restore_walker</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">for</span> <span class="tok-n">walker</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">():</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">count_colocations</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-p">)</span>

    <span class="tok-n">tick</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">tick</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-p">(</span><span class="tok-n">tick</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-c1"># clear the meet log counts for the next tick</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">max_meets</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">min_meets</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">meet_log</span><span class="tok-o">.</span><span class="tok-n">total_meets</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>    <i class="conum" data-value="5"></i><b>(5)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Calls <code>walk</code> on each <code>Walker</code> agent. <code>self.context.agents</code> returns an iterator over all the
agents in the model. See <a href="#_walking_the_walker">Section 5.1.1, &#8220;Walking the Walker&#8221;</a> for more information on the <code>walk</code> method,
and the <code>SharedContext</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.context.html#repast4py.context.SharedContext.agents">API documenation</a>
for more information on the <code>agents</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Synchronizes the state of the simulation across processes using the <code>restore_walker</code>
function to restore any <code>Walkers</code> that have moved processes. See <a href="#_restoring_walkers">Section 5.3, &#8220;Restoring Walkers&#8221;</a>
for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Updates <code>self.meet_log</code> with each agent&#8217;s colocation data by calling <code>count_colocations</code>
on each <code>Walker</code>. See <a href="#_logging_the_walker">Section 5.1.2, &#8220;Logging the Walker&#8221;</a> for the details.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Logs the current values of the <code>self.meet_log</code> by calling <code>log</code> on the <code>self.data_set</code> <code>ReducingDataSet</code>.
As we saw earlier, the <code>log</code> method takes a floating point argument that specifies the tick at which the data was logged.
In this case, we use the current tick value.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Resets the <code>self.meet_log</code> values back to 0 because we want to log the data per tick, rather than
a running total.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Call <code>synchronize</code> on your <code>SharedContext</code> whenever you need to synchronize
the state of the simulation across processes. For example, when agents moving on a
grid or space may have crossed into a subsection of the global grid that is
managed by a different process or when the buffer areas need to be updated.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second repeating event (<code>self.runner.schedule_repeating_event(1.1, 10, self.log_agents)</code>) is
scheduled to call <code>Model.log_agents</code> starting at tick 1.1, and then every 10 ticks thereafter. See the discussion
of <code>log_agents</code> in <a href="#_initializing_logging">Section 5.2.4, &#8220;Initializing Logging&#8221;</a> for more information.</p>
</div>
<div class="paragraph">
<p>The final event (<code>self.runner.schedule_end_event(self.at_end)</code>) is scheduled to call
<code>Model.at_end</code> when the simulation ends. This method closes the two logs,
insuring that any remaining unwritten data is written to their respective
files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">at_end</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">close</span><span class="tok-p">()</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">agent_logger</span><span class="tok-o">.</span><span class="tok-n">close</span><span class="tok-p">()</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do not forget to call <code>close</code> on your logging class instances when the simulation ends.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restoring_walkers">5.3. Restoring Walkers</h3>
<div class="paragraph">
<p>The <code>restore_walker</code> function is used to create an individual <code>Walker</code> when that
<code>Walker</code> has moved (i.e., walked) to another process. This function is passed
to the <code>synchronize</code> method (i.e., <code>self.context.synchronize(restore_walker)</code>)
and is called in the synchronization mechanism. The <code>restore_walker</code> function
is the reverse of the <code>Walker.save</code> method discussed in <a href="#_serializing_the_walker">Section 5.1.3, &#8220;Serializing the Walker&#8221;</a>,
unpacking the tuple returned by that to create a <code>Walker</code> agent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><pre><span></span><span class="tok-n">walker_cache</span> <span class="tok-o">=</span> <span class="tok-p">{}</span>    <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-k">def</span> <span class="tok-nf">restore_walker</span><span class="tok-p">(</span><span class="tok-n">walker_data</span><span class="tok-p">:</span> <span class="tok-n">Tuple</span><span class="tok-p">):</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-sd">&quot;&quot;&quot;</span>
<span class="tok-sd">    Args:</span>
<span class="tok-sd">        walker_data: tuple containing the data returned by Walker.save.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-c1"># uid is a 3 element tuple: 0 is id, 1 is type, 2 is rank</span>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">walker_data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">pt_array</span> <span class="tok-o">=</span> <span class="tok-n">walker_data</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span>
    <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">DiscretePoint</span><span class="tok-p">(</span><span class="tok-n">pt_array</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">pt_array</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="tok-k">if</span> <span class="tok-n">uid</span> <span class="tok-ow">in</span> <span class="tok-n">walker_cache</span><span class="tok-p">:</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">walker</span> <span class="tok-o">=</span> <span class="tok-n">walker_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span>
    <span class="tok-k">else</span><span class="tok-p">:</span>    <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-n">walker</span> <span class="tok-o">=</span> <span class="tok-n">Walker</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span> <span class="tok-n">pt</span><span class="tok-p">)</span>
        <span class="tok-n">walker_cache</span><span class="tok-p">[</span><span class="tok-n">uid</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">walker</span>

    <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">meet_count</span> <span class="tok-o">=</span> <span class="tok-n">walker_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>    <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="tok-n">walker</span><span class="tok-o">.</span><span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">pt</span>
    <span class="tok-k">return</span> <span class="tok-n">walker</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use a caching strategy when restoring Walkers. This
dictionary is the cache of previously created walkers. The dictionary
keys are the Walker unique ids, and the values are the Walker instances.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>walker_data</code> tuple is the same tuple as created by the <code>Walker.save</code>
method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The first element of the tuple is the Walker&#8217;s unique id.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creates a <code>DiscretePoint</code> from point coordinate array. This
is the current location of the <code>Walker</code> being restored.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Checks if the <code>Walker</code> unique id is in the cache. If it is, then retrieve that <code>Walker</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If the unique id is not in the cache, then create a <code>Walker</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Updates the <code>Walker</code> state with the <code>meet_count</code> and point
data.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_simulation">5.4. Running the Simulation</h3>
<div class="paragraph">
<p>The simulation is run from the command line:</p>
</div>
<div class="paragraph">
<p><code>mpirun -n 4 python examples/rndwalk/rndwalk.py examples/rndwalk/random_walk.yaml</code></p>
</div>
<div class="paragraph">
<p>Here we are running the simulation with 4 process ranks and the model input parameters are
in the <code>examples/rndwalk/random_walk.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nt">random.seed</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">42</span>
<span class="tok-nt">stop.at</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span>
<span class="tok-nt">walker.count</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1000</span>
<span class="tok-nt">world.width</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span>
<span class="tok-nt">world.height</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">2000</span>
<span class="tok-nt">meet_log_file</span><span class="tok-p">:</span> <span class="tok-s">&#39;output/meet_log.csv&#39;</span>
<span class="tok-nt">agent_log_file</span><span class="tok-p">:</span> <span class="tok-s">&#39;output/agent_log.csv&#39;</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_parsing_input_parameters">5.4.1. Parsing Input Parameters</h4>
<div class="paragraph">
<p>An <code>if <em>name</em> == '<em>main</em>'</code> code block is used to parse the input parameters and
run the simulation. The <code>repast4py.parameters</code> module contains utility functions
for parsing both command line and model input parameter files, including a
default parser for command line arguments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;__main__&quot;</span><span class="tok-p">:</span>
    <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">create_args_parser</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">parse_args</span><span class="tok-p">()</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">init_params</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters_file</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates the default command line argument parser.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parses the command line into its arguments using that default parser</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates the model input parameters dictionary from those arguments using
<code>parameters.init_params</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default command line parser created with <code>parameters.create_args_parser</code> accepts
a path to a yaml format parameters input file, and a json format dictionary string
that will override parameters in the parameters file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ python examples/rndwalk/rndwalk.py -h
usage: rndwalk.py [-h] parameters_file [parameters]

positional arguments:
  parameters_file  parameters file (yaml format)
  parameters       json parameters string

optional arguments:
  -h, --help       show this help message and exit</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>parameters.init_params</code> takes the parameters file and the json string and creates a dictionary
of model input parameters whose keys are the parameter names and values are the parameter values.
This dictionary is returned by the function and is available via the module itself as <code>parameters.params</code>.
For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">parameters</span>
<span class="tok-o">...</span>
<span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">init_params</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters_file</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters</span><span class="tok-p">)</span>
<span class="tok-o">...</span>
<span class="tok-n">num_agents</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;num.agents&#39;</span><span class="tok-p">]</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the parameters file or the json input contains a parameter named <code>random.seed</code>,
the default random number generator (i.e., <code>repast4py.random.default_rng</code>) is initialized
with that seed. See the <code>repast4py.parameters</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.parameters.html">API documentation</a> for more information.</p>
</div>
<div class="paragraph">
<p>Lastly we have a simple <code>run</code> function that creates the <code>Model</code> class and calls its
<code>start</code> method, which starts the simulation by starting schedule execution. This <code>run</code> function is called
in the <code>if <em>name</em> == '<em>main</em>'</code> code block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">):</span>
    <span class="tok-n">model</span> <span class="tok-o">=</span> <span class="tok-n">Model</span><span class="tok-p">(</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">)</span>
    <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">start</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the simulation by executing the schedule which
calls the scheduled methods at the appropriate times and frequency.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code in the <code>run</code> function could be moved to the <code>if <em>name</em> == '<em>main</em>'</code> code block,
but it is often useful to have an entry type function that initializes and starts a simulation.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_2_the_rumor_network_model">6. Tutorial 2 - The Rumor Network Model</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview">6.1. Overview</h3>
<div class="paragraph">
<p>The Rumor model is a simple network model that illustrates Repast4Py&#8217;s network
agent-based model features. The simulation models the spread of a rumor through a networked population.
During initialization some number of agents (network nodes) are marked as rumor spreaders. At each iteration of the simulation, a random draw is made to determine if the neighbors of any rumor-spreading nodes have received the rumor. This draw is performed once for each neighbor. After all of the neighbors that can receive the rumor have been processed, the collection of rumor spreaders is updated
to include those nodes that received the rumor.</p>
</div>
<div class="paragraph">
<p><strong>This text assumes you have already read the <em>Repast4Py Users Guide</em> up through <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>.</strong></p>
</div>
<div class="paragraph">
<p>See the <a href="https://repast.github.io/repast4py.site/examples/examples.html">Repast4Py Examples</a> page to download the source code for this model
and for more information on getting started with the examples.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_network">6.2. The Network</h3>
<div class="paragraph">
<p>The Rumor model network is initialized from the <code>examples/rumor/network.txt</code> file included with the example model.
This file assigns each network node, corresponding to each model agent,
to a process rank. Repast4Py creates a <code>repast4py.network.SharedNetwork</code>
from this file, instantiating the agents on the correct ranks and creating the edges between
the agents appropriately. When an edge is between agents on different process ranks Repast4Py will create a <em>ghost</em> agent whose state mirrors that of the agent on the other process, and then create an edge using this ghost. For example, if an edge exists between <code>A</code> and <code>B</code> and <code>A</code> is on rank 1 and <code>B</code> on rank 2, then
Repast4Py will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a ghost of <code>B</code> on rank 1</p>
</li>
<li>
<p>Create a ghost of <code>A</code> on rank 2</p>
</li>
<li>
<p>Create an edge between <code>A</code> and the ghost <code>B</code> on rank 1</p>
</li>
<li>
<p>Create an edge between <code>B</code> and the ghost <code>A</code> on rank 2</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information about ghost agents and how their state is maintained see the <a href="#_distributed_simulation">Distributed Simulation</a> and <a href="#_cross_process_code_requirements">Cross-Process Code Requirements</a> sections.</p>
</div>
<div class="paragraph">
<p>The <code>network.txt</code> file was created using <code>rumor.generate_network_file</code> to distribute a
connected Watts and Strogatz graph generated by the <a href="https://networkx.org">networkx</a> Python package across 4 process ranks. <code>rumor.generate_network_file</code>
uses Repast4Py&#8217;s capability to take a  <a href="https://networkx.org">networkx</a> Graph object and distribute it across a specified number of
process ranks and write this distributed network to a file. A model can then create a SharedNetwork instance from this file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">import</span> <span class="tok-nn">networkx</span> <span class="tok-k">as</span> <span class="tok-nn">nx</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.network</span> <span class="tok-kn">import</span> <span class="tok-n">write_network</span><span class="tok-p">,</span> <span class="tok-n">read_network</span>
<span class="tok-o">...</span>
<span class="tok-k">def</span> <span class="tok-nf">generate_network_file</span><span class="tok-p">(</span><span class="tok-n">fname</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">n_ranks</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">n_agents</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">):</span>
    <span class="tok-sd">&quot;&quot;&quot;Generates a network file using Repast4Py.network.write_network.</span>

<span class="tok-sd">    Args:</span>
<span class="tok-sd">        fname: the name of the file to write to</span>
<span class="tok-sd">        n_ranks: the number of process ranks to distribute the file over</span>
<span class="tok-sd">        n_agents: the number of agents (node) in the network</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-n">g</span> <span class="tok-o">=</span> <span class="tok-n">nx</span><span class="tok-o">.</span><span class="tok-n">connected_watts_strogatz_graph</span><span class="tok-p">(</span><span class="tok-n">n_agents</span><span class="tok-p">,</span> <span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-mf">0.25</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">try</span><span class="tok-p">:</span>
        <span class="tok-kn">import</span> <span class="tok-nn">nxmetis</span>
        <span class="tok-n">write_network</span><span class="tok-p">(</span><span class="tok-n">g</span><span class="tok-p">,</span> <span class="tok-s1">&#39;rumor_network&#39;</span><span class="tok-p">,</span> <span class="tok-n">fname</span><span class="tok-p">,</span> <span class="tok-n">n_ranks</span><span class="tok-p">,</span> <span class="tok-n">partition_method</span><span class="tok-o">=</span><span class="tok-s1">&#39;metis&#39;</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">except</span> <span class="tok-ne">ImportError</span><span class="tok-p">:</span>
        <span class="tok-n">write_network</span><span class="tok-p">(</span><span class="tok-n">g</span><span class="tok-p">,</span> <span class="tok-s1">&#39;rumor_network&#39;</span><span class="tok-p">,</span> <span class="tok-n">fname</span><span class="tok-p">,</span> <span class="tok-n">n_ranks</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a connected Watts and Strogatz graph using  <a href="https://networkx.org">networkx</a>. See the networkx <a href="https://networkx.org/documentation/stable/reference/generated/networkx.generators.random_graphs.connected_watts_strogatz_graph.html">API Docs</a> for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the nxmetis package is available, distribute the graph using the metis partition method,
and write it out to <code>fname</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If nxmetis is not available, distribute the graph using the default random partition method,
and write it out to <code>fname</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the API documentation for <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.network.html#repast4py.network.write_network"><code>repast4py.network.write_network</code></a> for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_rumor_model_implementation">6.3. The Rumor Model Implementation</h3>
<div class="paragraph">
<p>The Rumor Model implementation follows the typical Repast4Py structure and consists of the following parts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>RumorAgent</code> class that implements the agent state and behavior</p>
</li>
<li>
<p>A <code>Model</code> class responsible for initialization and managing the simulation</p>
</li>
<li>
<p>A <code>create_rumor_agent</code> function used to create the Rumor agents when creating the
network from a saved file</p>
</li>
<li>
<p>A <code>restore_agent</code> function used to create an individual <code>RumorAgent</code> when that
<code>RumorAgent</code> has been ghosted (i.e., created as a ghost agent) on another process rank</p>
</li>
<li>
<p>A <code>run</code> function that creates and starts the simulation</p>
</li>
<li>
<p>An <code>if <em>name</em> == "<em>main</em>"</code> block that allows the simulation to be run
from the command line</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_the_rumor_agent">6.3.1. The Rumor Agent</h4>
<div class="paragraph">
<p>The Rumor model&#8217;s agent is a simple class with a single <code>received_rumor</code> boolean attribute that
specifies whether or not the agent has received the rumor. It also has the canonical <code>save</code> and
<code>update</code> methods used to move and copy the agent between processes and to update the state of a
ghost agent from its originating process rank.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">RumorAgent</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">nid</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">agent_type</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">received_rumor</span><span class="tok-o">=</span><span class="tok-kc">False</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-n">nid</span><span class="tok-p">,</span> <span class="tok-n">agent_type</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-o">=</span> <span class="tok-n">received_rumor</span>    <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-sd">&quot;&quot;&quot;Saves the state of this agent as a tuple.</span>

<span class="tok-sd">        A non-ghost agent will save its state using this</span>
<span class="tok-sd">        method, and any ghost agents of this agent will</span>
<span class="tok-sd">        be updated with that data (self.received_rumor).</span>

<span class="tok-sd">        Returns:</span>
<span class="tok-sd">            The agent&#39;s state</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span><span class="tok-p">)</span>

    <span class="tok-k">def</span> <span class="tok-nf">update</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">data</span><span class="tok-p">:</span> <span class="tok-nb">bool</span><span class="tok-p">):</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-sd">&quot;&quot;&quot;Updates the state of this agent when it is a ghost</span>
<span class="tok-sd">        agent on a rank other than its local one.</span>

<span class="tok-sd">        Args:</span>
<span class="tok-sd">            data: the new agent state (received_rumor)</span>
<span class="tok-sd">        &quot;&quot;&quot;</span>
        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-ow">and</span> <span class="tok-n">data</span><span class="tok-p">:</span>
            <span class="tok-c1"># only update if the received rumor state</span>
            <span class="tok-c1"># has changed from false to true</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-o">=</span> <span class="tok-n">data</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>RumorAgent extends <code>repast4py.core.agent</code> as is required by all Repast4Py agents</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calls the <code>core.Agent</code> constructor, passing the node id, agent_type, and originating rank.
Together these will create a globally unique id for this agent.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>received_rumor</code> boolean specifies whether the agent has received the rumor
and is able to spread it.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The required <code>save</code> method for saving the agent&#8217;s state as a tuple. This state
can be used to update ghosts of this agent on other ranks.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The required <code>update</code> method for updating ghosts from saved agent state. Here,
we only update if the <code>received_rumor</code> state has changed from False to True. If so,
then add this agent to the Model&#8217;s list of rumor spreading agents (<a href="#_seeding_the_rumors">Section 6.3.2.2, &#8220;Seeding the Rumors&#8221;</a>).</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_model_class_2">6.3.2. The Model Class</h4>
<div class="paragraph">
<p>As in <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>, the Model class encapsulates the simulation.
It is responsible for initialization, scheduling events, creating agents and their network, and managing logging.
It also defines the scheduled events that drive the simulation forward.</p>
</div>
<div class="paragraph">
<p>In the <code>Model</code> constructor, we create the simulation schedule,
the network, seed the network with the rumors, and initialize the loggers that
we use to log the rumor counts to a file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span><span class="tok-p">,</span> <span class="tok-n">random</span><span class="tok-p">,</span> <span class="tok-n">schedule</span><span class="tok-p">,</span> <span class="tok-n">logging</span><span class="tok-p">,</span> <span class="tok-n">parameters</span>
<span class="tok-o">...</span>
<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span> <span class="tok-o">=</span> <span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">init_schedule_runner</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_repeating_event</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">step</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_stop</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;stop.at&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_end_event</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">at_end</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Before any events can be scheduled, the schedule runner must be initialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Schedules <code>Model.step</code> to execute starting at tick 1 and then every tick thereafter. Repeating events are scheduled with <code>schedule.repeating_event</code>.
The first argument is the start tick, and the second is the frequency for repeating.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>schedule_stop</code> schedules the tick at which the simulation should stop. At this tick,
events will no longer be popped off the schedule and executed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>schedule_end_event</code> can be used to schedule methods that perform some sort of
<em>clean up</em> type operation when the simulation ends, closing a log file, for example.
This is called at the tick specified in <code>schedule_stop</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Once the default scheduler runner has been initialized with <code>schedule.init_schedule_runner</code>, you can get a reference to it with <code>schedule.runner()</code>. See the schedule model API documentation for
more information on different ways to schedule events (methods and functions).
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A simulation stopping time must be set with <code>schedule_stop</code>. Without a stopping time
the simulation will continue to run, seeming to hang if there are no events to execute, or
continuing to execute any scheduled events without stopping. The stopping time does not
need to be set during initialization, but can be set during a simulation run when a
stopping condition is reached.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_creating_the_network">Creating the Network</h5>
<div class="paragraph">
<p>As described in <a href="#_the_network">Section 6.2, &#8220;The Network&#8221;</a> the Rumor model network is initialized
from a file. The <code>repast4py.network.read_network</code> function reads this
file and creates a SharedNetwork instance from the network description
in the file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-n">fpath</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;network_file&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-n">SharedContext</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">read_network</span><span class="tok-p">(</span><span class="tok-n">fpath</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">create_rumor_agent</span><span class="tok-p">,</span> <span class="tok-n">restore_agent</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">net</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">get_projection</span><span class="tok-p">(</span><span class="tok-s1">&#39;rumor_network&#39;</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gets the path to the file describing the network from the parameters dictionary</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates a context to hold the agents and the network projection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creates the network from the named file, using the <code>create_rumor_agent</code>, and
<code>restore_agent</code> functions to create the agents and their necessary ghosts (<a href="#_creating_and_restoring_rumoragents">Section 6.3.3, &#8220;Creating and Restoring RumorAgents&#8221;</a>).
The created network is added to the specified context as part of this call.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Gets a reference to the named network from the context. The network
input file specifies the network name on its first line. This is the
network created in &lt;3&gt; and is an instance of an
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.network.html#repast4py.network.UndirectedSharedNetwork"><code>UndirectedSharedNetwork</code></a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_seeding_the_rumors">Seeding the Rumors</h5>
<div class="paragraph">
<p>We seed the network with some initial rumor spreaders by selecting a parameterized number of
agents and setting their <code>received_rumor</code> attribute to True. These agents
are added to the <code>Model&#8217;s</code> list of rumor spreaders.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">=</span> <span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_rank</span><span class="tok-p">()</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">_seed_rumor</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;initial_rumor_count&#39;</span><span class="tok-p">],</span> <span class="tok-n">comm</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>_seed_rumor</code> method uses MPI&#8217;s Scatter function to send
each rank the number of agents to initialize as rumor spreaders.
An MPI4Py scatter call takes a collection or array of values created on
one rank (the root rank) and sends the _ith_ element
of that collection or array to rank <em>i</em>. So for example,
rank 0 gets the <em>zeroth</em> element, rank 1 gets the <em>first</em>, and
so on. In <code>_seed_rumor</code>, we use a numpy array of ints as the array
to scatter and the _ith_ element of the array is the number of rumor
spreaders to initialize on rank <em>i</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">_seed_rumor</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">init_rumor_count</span><span class="tok-p">:</span> <span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">):</span>
    <span class="tok-n">world_size</span> <span class="tok-o">=</span> <span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_size</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-c1"># np array of world size, the value of i&#39;th element of the array</span>
    <span class="tok-c1"># is the number of rumors to seed on rank i.</span>
    <span class="tok-n">rumor_counts</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">zeros</span><span class="tok-p">(</span><span class="tok-n">world_size</span><span class="tok-p">,</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">int32</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">==</span> <span class="tok-mi">0</span><span class="tok-p">):</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-k">for</span> <span class="tok-n">_</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-n">init_rumor_count</span><span class="tok-p">):</span>
            <span class="tok-n">idx</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">integers</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">high</span><span class="tok-o">=</span><span class="tok-n">world_size</span><span class="tok-p">)</span>
            <span class="tok-n">rumor_counts</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>

    <span class="tok-n">rumor_count</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">empty</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-n">dtype</span><span class="tok-o">=</span><span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">int32</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Scatter</span><span class="tok-p">(</span><span class="tok-n">rumor_counts</span><span class="tok-p">,</span> <span class="tok-n">rumor_count</span><span class="tok-p">,</span> <span class="tok-n">root</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">)</span>     <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="tok-k">for</span> <span class="tok-n">agent</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">(</span><span class="tok-n">count</span><span class="tok-o">=</span><span class="tok-n">rumor_count</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">shuffle</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">):</span>    <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-n">agent</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">agent</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the total number of ranks over which the simulation is distributed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize a numpy array of <code>world_size</code> with zeros. <code>rumor_counts</code>
will hold the number of initial rumor spreaders for each rank.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If this Model&#8217;s rank is 0, then randomly select an index into the
<code>rumor_counts</code> array, and increment the value at that index by one. Do
this for a number of times equal to the initial number of rumors to seed.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create an empty array of size 1 to receive the number of rumors
from the Scatter call.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Scatter the values in <code>rumor_counts</code> from root rank 0 into the <code>rumor_count</code>
array on all the ranks. <code>rumor_count</code> now holds the number of initial
rumor spreaders assigned to the current rank.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Using the <code>SharedContext.agents</code> method, get an iterator over a number of agents equal to
the single value in <code>rumor_count</code> at random (<code>shuffle=True</code>). Set each one of those agent&#8217;s <code>received_rumor</code>
attribute to True, and add each one to the Model&#8217;s <code>rumor_spreaders</code> list.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Using MPI4Py&#8217;s Scatter in this way is a useful method for
randomly dividing up a total initialization value among ranks. In
the RumorModel, we tell each rank to initialize a number of rumor spreaders, and
the sum of all these values is the total number of initial rumor spreaders
specified by the input parameter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_logging">Logging</h5>
<div class="paragraph">
<p>As we saw in <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>, there are
two types of logging supported by Repast4Py, tabular and reduce-type logging (see the <code>repast4py.logging</code> module
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.logging.html#module-repast4py.logging">API documentation</a> for more information).</p>
</div>
<div class="paragraph">
<p>The Rumor model uses the second of these log types. The dataclass that we log records
the total number of rumor spreaders and the number of new rumor spreaders added during
a tick.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">RumorCounts</span><span class="tok-p">:</span>
    <span class="tok-n">total_rumor_spreaders</span><span class="tok-p">:</span> <span class="tok-nb">int</span>
    <span class="tok-n">new_rumor_spreaders</span><span class="tok-p">:</span> <span class="tok-nb">int</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>

    <span class="tok-n">rumored_count</span> <span class="tok-o">=</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span> <span class="tok-o">=</span> <span class="tok-n">RumorCounts</span><span class="tok-p">(</span><span class="tok-n">rumored_count</span><span class="tok-p">,</span> <span class="tok-n">rumored_count</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">loggers</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">create_loggers</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-n">op</span><span class="tok-o">=</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">SUM</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">ReducingDataSet</span><span class="tok-p">(</span><span class="tok-n">loggers</span><span class="tok-p">,</span> <span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-p">,</span>
                                            <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;counts_file&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="5"></i><b>(5)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the current number of rumor spreaders immediately after rumor seeding</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the RumorCount instance, setting the <code>total_rumor_spreaders</code> and <code>new_rumor_spreaders</code>
to the current number of rumor spreaders</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a list of loggers that use <code>self.counts</code> as the source of the data to log,
and that perform a cross process rank summation of that data. The <code>names</code> argument is not
specified, so the <code>RumorCounts</code> field names will be used as column headers.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create a <code>logging.ReducingDataSet</code> from the loggers where <code>params['counts_file']</code>
is the name of the file to log to.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Log the initial (i.e., tick 0) values from <code>self.counts</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_scheduled_methods_2">Scheduled Methods</h5>
<div class="paragraph">
<p>The Model&#8217;s <code>step</code> method is scheduled to execute starting
at tick 1 and then every tick thereafter. It is in the step method that the rumor spreading
is implemented. The implementation is a nested loop that iterates through all the network neighbors
of each rumor spreader. If the network neighbor has not yet received a rumor, is local
to the current rank, and the draw against the probability of a rumor spreading is successful, then
we set the neighbor&#8217;s <code>received_rumor</code> attribute to True, and ultimately add it to the
Model&#8217;s list of rumor spreaders.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Each <code>repast4py.network.SharedNetwork</code> instance contains a reference to a <code>networkx.Graph</code>
instance named <code>graph</code>. Use <code>graph</code> for any network queries that do not change the
structure of the network. For example, <code>graph.neighbors(n)</code> will return the network neighbors
of agent n. See the <a href="https://networkx.org/documentation/stable/reference/index.html">networkx API documentation</a> for more info.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">step</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-n">new_rumor_spreaders</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">rng</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span>
    <span class="tok-k">for</span> <span class="tok-n">agent</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span><span class="tok-p">:</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-k">for</span> <span class="tok-n">ngh</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">net</span><span class="tok-o">.</span><span class="tok-n">graph</span><span class="tok-o">.</span><span class="tok-n">neighbors</span><span class="tok-p">(</span><span class="tok-n">agent</span><span class="tok-p">):</span>
            <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">ngh</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-ow">and</span> <span class="tok-n">ngh</span><span class="tok-o">.</span><span class="tok-n">local_rank</span> <span class="tok-o">==</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span>  \
               <span class="tok-ow">and</span> <span class="tok-n">rng</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">()</span> <span class="tok-o">&lt;=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_prob</span><span class="tok-p">:</span>
                <span class="tok-n">ngh</span><span class="tok-o">.</span><span class="tok-n">received_rumor</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
                <span class="tok-n">new_rumor_spreaders</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">ngh</span><span class="tok-p">)</span>

    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rumor_spreaders</span> <span class="tok-o">+=</span> <span class="tok-n">new_rumor_spreaders</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-o">.</span><span class="tok-n">new_rumor_spreaders</span> <span class="tok-o">=</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">new_rumor_spreaders</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-o">.</span><span class="tok-n">total_rumor_spreaders</span> <span class="tok-o">+=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-o">.</span><span class="tok-n">new_rumor_spreaders</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">tick</span><span class="tok-p">)</span>    <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">synchronize</span><span class="tok-p">(</span><span class="tok-n">restore_agent</span><span class="tok-p">)</span>    <i class="conum" data-value="7"></i><b>(7)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a list to hold any new rumor spreaders, i.e., agents whose <code>received_rumor</code> attribute
is set to True during this iteration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For each rumor spreader, iterate through all of its network neighbors. If the network neighbor
has not yet received a rumor, is local to the current rank, and the draw against
the probability of a rumor spreading is successful, then set the neighbor&#8217;s <code>received_rumor</code>
attribute to True, and add it to the list of new rumor spreaders.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the new rumor spreaders to the list of current rumor spreaders</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the new number of rumor spreaders on the <code>self.counts</code> log</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the total number of rumor spreaders on the <code>self.counts</code> log</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Log the <code>self.count</code> values for the current tick</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Synchronize the model state across all ranks. This will update all
the ghost agent states, calling <code>RumorAgent.update</code> on the ghost agents.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The list of rumor spreaders (<code>rumor_spreaders</code>) can contain ghost agents. As we saw in
<a href="#_the_rumor_agent">The Rumor Agent</a>, <code>RumorAgent.update</code> is called to update the state of ghost agents. If
the update changes the <code>received_rumor</code> attribute to True, then that ghost agent is added to
the Model&#8217;s list of rumor spreaders.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Never update the state of a ghost agent. A ghost agent is a mirror of an agent local
to some other process. The ghost agent&#8217;s state will be updated from that local source agent
during the <code>synchronize</code> call overwriting any changes. The Rumor Model checks if the local rank
of a rumor spreader&#8217;s network neighbor is the current rank (<code>ngh.local_rank == self.rank</code>)
before updating the neighbor&#8217;s state in order to avoid updating ghost state.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The final event (<code>self.runner.schedule_end_event(self.at_end)</code>) is scheduled to call
<code>Model.at_end</code> when the simulation ends. This method closes the logging data set,
ensuring that any remaining unwritten data is written out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">at_end</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
    <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">close</span><span class="tok-p">()</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Do not forget to call <code>close</code> on your logging class instances when the simulation ends.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_and_restoring_rumoragents">6.3.3. Creating and Restoring RumorAgents</h4>
<div class="paragraph">
<p>RumorAgents are created during the <code>read_network</code> call in the <code>Model</code>
constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><pre><span></span><span class="tok-n">read_network</span><span class="tok-p">(</span><span class="tok-n">fpath</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-p">,</span> <span class="tok-n">create_rumor_agent</span><span class="tok-p">,</span> <span class="tok-n">restore_agent</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There, as part of creating the network, the nodes (i.e., agents)
of that network are also created. Each rank creates the nodes that are assigned to
it using the passed in <code>create_rumor_agent</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">create_rumor_agent</span><span class="tok-p">(</span><span class="tok-n">nid</span><span class="tok-p">,</span> <span class="tok-n">agent_type</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">,</span> <span class="tok-o">**</span><span class="tok-n">kwargs</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-k">return</span> <span class="tok-n">RumorAgent</span><span class="tok-p">(</span><span class="tok-n">nid</span><span class="tok-p">,</span> <span class="tok-n">agent_type</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The nid, agent_type, and rank arguments are read from the network
input file and passed to this function. See the <code>repast4py.network.read_network</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.network.html#repast4py.network.read_network">API documentation</a> for more info.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As described in <a href="#_the_network">Section 6.2, &#8220;The Network&#8221;</a>, when an edge links two nodes
on different ranks, Repast4Py will create ghost agents as necessary and
create an edge between the ghosts and the local agents. The <code>restore_agent</code> function is
used to create the ghost on the rank it is ghosted to, using the state from
the source agent&#8217;s <code>save</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">restore_agent</span><span class="tok-p">(</span><span class="tok-n">agent_data</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">uid</span> <span class="tok-o">=</span> <span class="tok-n">agent_data</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span>
    <span class="tok-k">return</span> <span class="tok-n">RumorAgent</span><span class="tok-p">(</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">],</span> <span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">],</span> <span class="tok-n">agent_data</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>agent_data</code> is the tuple produced by an agent&#8217;s <code>save</code> method.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_simulation_2">6.3.4. Running the Simulation</h4>
<div class="paragraph">
<p>The simulation is run from the command line. For example, from within the
<code>examples/rumor</code> directory:</p>
</div>
<div class="paragraph">
<p><code>mpirun -n 4 python rumor.py rumor_model.yaml</code></p>
</div>
<div class="paragraph">
<p>Here we are running the simulation with 4 process ranks and the model input parameters are
in the <code>rumor_model.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nt">network_file</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">network.txt</span>
<span class="tok-nt">initial_rumor_count</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5</span>
<span class="tok-nt">stop.at</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">100</span>
<span class="tok-nt">rumor_probability</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">0.1</span>
<span class="tok-nt">counts_file</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">output/rumor_counts.csv</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Rumor Model uses the standard <code>if <em>name</em> == '<em>main</em>'</code> code block to parse the input parameters and
run the simulation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;__main__&quot;</span><span class="tok-p">:</span>
    <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">create_args_parser</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">parse_args</span><span class="tok-p">()</span>   <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">init_params</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters_file</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the default command line argument parser</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parse the command line into its arguments using that default parser</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the model input parameters dictionary from those arguments using
<code>parameters.init_params</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_parsing_input_parameters">Parsing Input Parameters</a> in Tutorial 1 for more details.</p>
</div>
<div class="paragraph">
<p>Lastly we have a simple <code>run</code> function that creates the <code>Model</code> class and calls its
<code>start</code> method which starts the simulation by starting schedule execution. This <code>run</code> function is called
in the <code>if <em>name</em> == '<em>main</em>'</code> code block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">):</span>
    <span class="tok-n">model</span> <span class="tok-o">=</span> <span class="tok-n">Model</span><span class="tok-p">(</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">)</span>
    <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">start</span><span class="tok-p">()</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">start</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the simulation by executing the schedule which
calls the scheduled methods at the appropriate times and frequency.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code in the <code>run</code> function could be moved to the <code>if <em>name</em> == '<em>main</em>'</code> code block,
but it is often useful to have an entry type function that initializes and starts a simulation.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tutorial_3_the_zombies_model">7. Tutorial 3 - The Zombies Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>, we developed a simple model in which agents walk at random around a 2-dimensional Cartesian grid. The Zombies Model builds on this simple movement implementation, adding an additional agent type and using a Continuous Space.</p>
</div>
<div class="paragraph">
<p><strong>This text assumes you have already read the <em>Repast4Py Users Guide</em> up through <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>.</strong></p>
</div>
<div class="paragraph">
<p>In the Zombies model, human agents are pursued by zombie agents, and once caught become zombies themselves. Each timestep, the following occurs:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All the Zombies:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Query their immediate neighborhood to determine the adjacent grid location with
the most number of Humans</p>
</li>
<li>
<p>Move towards that location, assuming any Humans are found</p>
</li>
<li>
<p>Infect the Humans at that location, also assuming any Humans are found</p>
</li>
</ol>
</div>
</li>
<li>
<p>All the Humans:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Become a Zombie, after being infected for 10 timesteps, else</p>
</li>
<li>
<p>Query their immediate neighborhood to determine the adjacent grid location with
the fewest number of Zombies</p>
</li>
<li>
<p>Move to that location at twice the speed of a Zombie.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>See the <a href="https://repast.github.io/repast4py.site/examples/examples.html">Repast4Py Examples</a> page to download the source code for this model
and for more information on getting started with the examples.</p>
</div>
<div class="paragraph">
<p>The code consists of the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Two agent classes: a <a href="#_the_zombie_agent">Zombie class</a> that implements the behavior of the zombie agents, and a <a href="#_the_human_agent">Human class</a> that implements the state and behavior of the human agents.</p>
</li>
<li>
<p><a href="#_restoring_the_agents">A restore function</a> that creates both Zombie and Human agents when they are moved from one MPI rank to another.</p>
</li>
<li>
<p>A <a href="#_the_model_class_3">Model class</a> responsible for initializing and managing the simulation and
simulation components, including:</p>
<div class="ulist">
<ul>
<li>
<p>the model&#8217;s <a href="#_scheduling_events_and_creating_the_context">context</a></p>
</li>
<li>
<p><a href="#_implementing_spatial_projections">Continuous Space and Discrete Grid</a> projections,</p>
</li>
<li>
<p><a href="#Scheduled methods">Scheduled Events</a>, and</p>
</li>
<li>
<p><a href="#_logging">Logging</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>A <a href="#_the_grid_neighborhood_finder">GridNghFinder</a> class for quickly computing neighboring grid locations using
numpy and the the <a href="https://numba.pydata.org">Numba</a> Python package to accelerate the computation</p>
</li>
<li>
<p>The standard <code>run</code> function that creates and starts the simulation.</p>
</li>
<li>
<p>The standard <code>if <em>name</em> == "<em>main</em>"</code> block in which input parameters are parsed and
allows the simulation to be run from the command line.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Model class instance <code>model</code> is a global variable defined as an attribute of the
zombies module itself. Consequently, it is available to all the code in <code>zombies.py</code> as just
<code>model</code>, that is, you will see it referenced as <code>model</code> rather than <code>self.model</code> or as a
function argument. The Model class contains references to the discrete grid and continuous space
projections as well as the grid neighborhood finder. These are used by the agents
in the implementation of their behavior. By making <code>model</code> a global variable, our
agents can conveniently access these required components.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_the_agent_classes">7.1. The Agent Classes</h3>
<div class="paragraph">
<p>The Zombies model implements two agent classes: a <code>Zombie</code> and a <code>Human</code>. The zombie&#8217;s behavior
is to pursue humans across a two dimensional Cartesian space and infect them. The human&#8217;s behavior
is to flee from zombies. Humans contain a boolean (<code>infected</code>) field indicating whether or not they are infected, and an integer (<code>infected_duration</code>) field tracking the duration of the infection. When that
value reaches 10, that human is replaced with a zombie. The methods that implement infection, and
the transition from human to zombie are described in <a href="#_the_zombie_step_method">the Zombie step method</a>, the <a href="#_the_human_step_method">the Human step method</a>, and <a href="#_step">the Model class scheduled step method</a>.</p>
</div>
<div class="paragraph">
<p>Both agents inhabit two two-dimensional projections:
a <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid"><code>SharedGrid</code></a> and a
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedCSpace"><code>SharedCSpace</code></a>. The
first of these is a matrix type grid where the agent locations are expressible
as discrete integer coordinates. The second is a continuous space where the agent locations
are expressible as continuous floating point coordinates. The grid is used to implement agent
vision. Humans and zombies can <em>see</em> the zombies and humans in the grid locations
that neighbor their own, and act accordingly. The continuous space is used for movement, and
unlike the <code>Walker</code> agents in <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a> which move a single
grid unit at a time, the human and zombie agents move in fractions of a grid unit,
0.25 for zombies, and 0.5 grid units for humans. In this way, the humans are twice as fast as
the zombies. When a human or zombie moves in the continuous space, a method in the
<code>Model</code> class updates its location in the grid space. These spatial aspects are described in
detail in the <a href="#_implementing_spatial_projections">Implementing Spatial Projections</a> subsection.</p>
</div>
<div class="sect3">
<h4 id="_the_zombie_agent">7.1.1. The Zombie Agent</h4>
<div class="paragraph">
<p>We implement our Zombie agent using the <code>Zombie</code> class. As required for all Repast4Py agent implementations, the <code>Zombie</code> class extends
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a>, passing it the components of the unique agent id tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Zombie</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">TYPE</span> <span class="tok-o">=</span> <span class="tok-mi">1</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">a_id</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">a_id</span><span class="tok-p">,</span> <span class="tok-nb">type</span><span class="tok-o">=</span><span class="tok-n">Zombie</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Zombie</code> subclasses <code>repast4py.core.Agent</code>. Subclassing <code>Agent</code> is a requirement for all Repast4Py agent implementations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TYPE</code> is a class variable that defines the agent type id for the Zombie agents. This is a required part of the unique agent id tuple.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In order to uniquely identify the agent across all ranks in the simulation, the
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a> constructor takes the following three arguments: an integer id that uniquely identifies an agent on the process where it was created, a non-negative integer identifying the type of the agent, and the rank on which the agent is created.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_the_zombie_step_method">The Zombie step() Method</h5>
<div class="paragraph">
<p>The zombie agent behavior is implemented in its <code>step</code> method. Here, the zombie queries its immediate neighborhood to find the location with the most humans. Assuming some humans are found, the zombie will then move towards that grid location. If multiple grid locations have the maximum number of humans, including when the maximum is 0, the zombie will choose one of those locations at random.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Each zombie agent is characterized solely by its behavior. That is, the zombie agent does not have an internal state, and is only described by its unique agent tuple id.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The 8 member neighborhood of grid cells surrounding an agent&#8217;s 2D grid location is called its Moore neighborhood. Given a grid location, its 8 neighbors and the current location are computed using the
<a href="#_the_grid_neighborhood_finder">GrdNghFinder</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span><span class="tok-p">,</span> <span class="tok-n">space</span><span class="tok-p">,</span> <span class="tok-n">schedule</span><span class="tok-p">,</span> <span class="tok-n">logging</span><span class="tok-p">,</span> <span class="tok-n">random</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">ContinuousPoint</span> <span class="tok-k">as</span> <span class="tok-n">cpt</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">DiscretePoint</span> <span class="tok-k">as</span> <span class="tok-n">dpt</span>
<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Zombie</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>
    <span class="tok-k">def</span> <span class="tok-nf">step</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">grid</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">grid</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_location</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">nghs</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">ngh_finder</span><span class="tok-o">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">y</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-n">at</span> <span class="tok-o">=</span> <span class="tok-n">dpt</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">maximum</span> <span class="tok-o">=</span> <span class="tok-p">[[],</span> <span class="tok-o">-</span><span class="tok-p">(</span><span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">maxsize</span> <span class="tok-o">-</span> <span class="tok-mi">1</span><span class="tok-p">)]</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-k">for</span> <span class="tok-n">ngh</span> <span class="tok-ow">in</span> <span class="tok-n">nghs</span><span class="tok-p">:</span>    <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="tok-n">at</span><span class="tok-o">.</span><span class="tok-n">_reset_from_array</span><span class="tok-p">(</span><span class="tok-n">ngh</span><span class="tok-p">)</span>    <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
            <span class="tok-k">for</span> <span class="tok-n">obj</span> <span class="tok-ow">in</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_agents</span><span class="tok-p">(</span><span class="tok-n">at</span><span class="tok-p">):</span>    <i class="conum" data-value="8"></i><b>(8)</b>
                <span class="tok-k">if</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">:</span>
                    <span class="tok-n">count</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
            <span class="tok-k">if</span> <span class="tok-n">count</span> <span class="tok-o">&gt;</span> <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]:</span>    <i class="conum" data-value="9"></i><b>(9)</b>
                <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">ngh</span><span class="tok-p">]</span>
                <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">count</span>
            <span class="tok-k">elif</span> <span class="tok-n">count</span> <span class="tok-o">==</span> <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]:</span>    <i class="conum" data-value="10"></i><b>(10)</b>
                <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">ngh</span><span class="tok-p">)</span>

        <span class="tok-n">max_ngh</span> <span class="tok-o">=</span> <span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">][</span><span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">integers</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">maximum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]))]</span>    <i class="conum" data-value="11"></i><b>(11)</b>

        <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">all</span><span class="tok-p">(</span><span class="tok-n">max_ngh</span> <span class="tok-o">==</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">coordinates</span><span class="tok-p">):</span>    <i class="conum" data-value="12"></i><b>(12)</b>
            <span class="tok-n">direction</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">max_ngh</span> <span class="tok-o">-</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">coordinates</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">:</span><span class="tok-mi">3</span><span class="tok-p">])</span> <span class="tok-o">*</span> <span class="tok-mf">0.25</span>    <i class="conum" data-value="13"></i><b>(13)</b>
            <span class="tok-n">cpt</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">get_location</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>    <i class="conum" data-value="14"></i><b>(14)</b>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">cpt</span><span class="tok-o">.</span><span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">direction</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">cpt</span><span class="tok-o">.</span><span class="tok-n">y</span> <span class="tok-o">+</span> <span class="tok-n">direction</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span>    <i class="conum" data-value="15"></i><b>(15)</b>

        <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_location</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>    <i class="conum" data-value="16"></i><b>(16)</b>
        <span class="tok-k">for</span> <span class="tok-n">obj</span> <span class="tok-ow">in</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_agents</span><span class="tok-p">(</span><span class="tok-n">pt</span><span class="tok-p">):</span>
            <span class="tok-k">if</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">ID</span><span class="tok-p">:</span>
                <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-n">infect</span><span class="tok-p">()</span>
                <span class="tok-k">break</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>Model</code> contains both the grid and continuous space in its <code>grid</code> and <code>space</code> fields. The <code>model</code>
variable contains the instance of the <code>Model</code> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the location of this zombie. This location is a <code>Discrete Point</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the <code>Model&#8217;s</code> instance of a <code>GridNghFinder</code> to get the Moore neighborhood
coordinates of the zombie&#8217;s current location.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create a temporary
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.DiscretePoint">DiscretePoint</a>
for use in the loop over the Moore neighborhood coordinates.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Initialize a list <code>maximum</code> that will be used to store the current maximum number of
human agents and the location(s) containing that maximum number. The first element
of the list stores the location(s), and the second the current maximum.
We set the initial maximum number of humans as <code>-(sys.maxsize - 1)</code>,
the smallest negative integer. Consequently, if there are 0 neighboring humans
then that becomes the new maximum, and the <code>maximum</code> list always contains
at least one location.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Iterate through all the neighboring locations to find the location(s) with the
maximum number of humans. For each neighbor location, we count the number of humans
at that location, and if the total count is equal to or greater than the current maximum, update
or reset the <code>maximum</code> list appropriately.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Reset the the <code>at</code> <code>DiscretePoint</code> to the current neighbor coordinates. This will be used in the <code>get_agents</code> call to come, which takes a <code>DiscretePoint</code> argument and this converts the <code>ngh</code> numpy array to a <code>DiscretePoint</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Get all the agents at the current neighbor location, and iterate through those agents to
count the number of humans. Humans are those agents where the type component of their
unique id tuple is equal to <code>Human.ID</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>If the count is greater than the current maximum count, reset the <code>maximum</code> list
to the current location, and maximum count.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>If the count is equal to the current maximum count, then append the current location
to the <code>maximum</code> list.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Select one of the <em>maximum neighbor locations</em> at random using Repast4Py&#8217;s default random number
generator. See the <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.random.html">API documentation</a> for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Check if the maximum neighbor location is the zombie&#8217;s current location,
using the <code>is_equal</code> function. If not, move the zombie toward the selected location.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Calculate the direction to move by subtracting the zombie&#8217;s current location from its desired location. The zombie is only able to move a distance of <code>0.25</code> spaces per step (i.e., its speed is <code>0.25 spaces/tick</code>), and so we multiply the direction vector by <code>0.25</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Get the zombie&#8217;s current location in the continuous space. As with the grid, the <code>Model</code> class
instance <code>model</code> contains the continuous space over which the agents move.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>Move the zombie using the Model&#8217;s <code>move()</code> method to the location computed by adding the current location
to the direction vector. <code>Model.move()</code> is described in <a href="#_implementing_spatial_projections">the Implementing Spatial Projections subsection</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Get the zombie&#8217;s current location in grid space and infect any humans found at that location. Infection is described in the <a href="#_the_human_agent">next section</a>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
As each zombie is only moving 0.25 spaces, it is possible for the grid location that a zombie "moves to" to be the same as its grid location before moving.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_saving_the_zombie_agent_state">Saving the Zombie agent state</h5>
<div class="paragraph">
<p>To move our zombie agent between processes, we must save its state. Because the zombie agent does not have an internal state, our <code>save</code> method returns only the zombie agent&#8217;s unique id tuple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Zombie</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>

    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">,)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_human_agent">7.1.2. The Human Agent</h4>
<div class="paragraph">
<p>The human agent state is composed of two variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whether or not the human is infected, and</p>
</li>
<li>
<p>The duration of the infection</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, the human has the following behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Querying the current neighborhood for the fewest number of zombies</p>
</li>
<li>
<p>Moving towards the location with the fewest number of zombies</p>
</li>
<li>
<p>Becoming a zombie after 10 time steps, once infected.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We implement our human agents using the <code>Human</code> class, subclassing <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.core.html#repast4py.core.Agent"><code>repast4py.core.Agent</code></a>, passing it the components of the unique agent id tuple.
The constructor also initializes the infected boolean to False and the duration of infection to 0.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span>
<span class="tok-o">...</span>
<span class="tok-k">class</span> <span class="tok-nc">Human</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="tok-n">TYPE</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>    <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">a_id</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-p">):</span>
        <span class="tok-nb">super</span><span class="tok-p">()</span><span class="tok-o">.</span><span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-nb">id</span><span class="tok-o">=</span><span class="tok-n">a_id</span><span class="tok-p">,</span> <span class="tok-nb">type</span><span class="tok-o">=</span><span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-n">rank</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected</span> <span class="tok-o">=</span> <span class="tok-kc">False</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected_duration</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Human</code> subclasses <code>repast4py.core.Agent</code>. Subclassing <code>Agent</code> is a requirement for all Repast4Py agent implementations.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TYPE</code> is a class variable that defines the agent type id the Human agent. This is a required part of the unique agent id tuple.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_human_behavior">Human Behavior</h5>
<div class="paragraph">
<p>Each human has three underlying behaviors:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Moving towards the area with the fewest zombies</p>
</li>
<li>
<p>Becoming infected by a zombie</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <a href="#_the_human_step_method"><code>step()</code></a> method for the human agent implements (1), and the <a href="#_the_infect_method"><code>infect()</code></a> method implements (2).</p>
</div>
<div class="sect5">
<h6 id="_the_human_step_method">The Human step() Method</h6>
<div class="paragraph">
<p>Much of the human <code>step</code> method is similar to that of the zombie. The human
also queries its Moore neighborhood, and moves in the direction of its
selected location. However, the human is searching for the location with
the fewest number of zombies, and moves to that location. In addition,
the human also increments its infected duration in the <code>step</code> method
and becomes a zombie if infected for 10 time steps.</p>
</div>
<div class="paragraph">
<p>Given the similarities
with the <a href="#_the_zombie_step_method"><code>Zombie step()</code></a> method only the
relevant differences will be highlighted below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Human</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>

    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">step</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">space_pt</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">get_location</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>
        <span class="tok-n">alive</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>     <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected</span><span class="tok-p">:</span>     <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected_duration</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
            <span class="tok-n">alive</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected_duration</span> <span class="tok-o">&lt;</span> <span class="tok-mi">10</span>

        <span class="tok-k">if</span> <span class="tok-n">alive</span><span class="tok-p">:</span>
            <span class="tok-n">grid</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">grid</span>
            <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_location</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">)</span>
            <span class="tok-n">nghs</span> <span class="tok-o">=</span> <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">ngh_finder</span><span class="tok-o">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">y</span><span class="tok-p">)</span>

            <span class="tok-n">minimum</span> <span class="tok-o">=</span> <span class="tok-p">[[],</span> <span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">maxsize</span><span class="tok-p">]</span>    <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tok-n">at</span> <span class="tok-o">=</span> <span class="tok-n">dpt</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span>
            <span class="tok-k">for</span> <span class="tok-n">ngh</span> <span class="tok-ow">in</span> <span class="tok-n">nghs</span><span class="tok-p">:</span>
                <span class="tok-n">at</span><span class="tok-o">.</span><span class="tok-n">_reset_from_array</span><span class="tok-p">(</span><span class="tok-n">ngh</span><span class="tok-p">)</span>
                <span class="tok-n">count</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
                <span class="tok-k">for</span> <span class="tok-n">obj</span> <span class="tok-ow">in</span> <span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">get_agents</span><span class="tok-p">(</span><span class="tok-n">at</span><span class="tok-p">):</span>
                    <span class="tok-k">if</span> <span class="tok-n">obj</span><span class="tok-o">.</span><span class="tok-n">uid</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">==</span> <span class="tok-n">Zombie</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">:</span>
                        <span class="tok-n">count</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>
                <span class="tok-k">if</span> <span class="tok-n">count</span> <span class="tok-o">&lt;</span> <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]:</span>    <i class="conum" data-value="4"></i><b>(4)</b>
                    <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">ngh</span><span class="tok-p">]</span>
                    <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-n">count</span>
                <span class="tok-k">elif</span> <span class="tok-n">count</span> <span class="tok-o">==</span> <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]:</span>
                    <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">ngh</span><span class="tok-p">)</span>

            <span class="tok-n">min_ngh</span> <span class="tok-o">=</span> <span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">][</span><span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">integers</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">minimum</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">]))]</span>

            <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">is_equal</span><span class="tok-p">(</span><span class="tok-n">min_ngh</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">coordinates</span><span class="tok-p">):</span>
                <span class="tok-n">direction</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">min_ngh</span> <span class="tok-o">-</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">coordinates</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-mf">0.5</span>
                <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span>
                            <span class="tok-n">space_pt</span><span class="tok-o">.</span><span class="tok-n">x</span> <span class="tok-o">+</span> <span class="tok-n">direction</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">],</span> <span class="tok-n">space_pt</span><span class="tok-o">.</span><span class="tok-n">y</span> <span class="tok-o">+</span> <span class="tok-n">direction</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">])</span> <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="tok-k">return</span> <span class="tok-p">(</span><span class="tok-ow">not</span> <span class="tok-n">alive</span><span class="tok-p">,</span> <span class="tok-n">space_pt</span><span class="tok-p">)</span>    <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize an <code>alive</code> variable that specifies whether or not this human is still alive (not a zombie).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the human is infected, increment its infection duration. If the infection duration is 10 or more, then set <code>alive</code> to <code>False</code>, indicating that this human should become a zombie.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initialize a list <code>minimum</code> that will be used to store the current minimum number of
zombie agents and the location(s) containing that minimum number. The first element
of the list stores the location(s), and the second the current minimum.
We set the initial minimum number of humans as <code>sys.maxsize</code>,
the largest integer, so that anything below that counts as the
new minimum value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Checks if the zombie count is less than the current minimum value, updating
appropriately if so.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Moves this human using the same mechanism as the zombie, but twice as far, 0.5 vs 0.25.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Return a tuple of <code>alive</code> and the human&#8217;s current location in the continuous space. This is returned
to the <code>Model</code> class calling code, which will replace the human with a zombie if the human is no
longer alive.</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_the_infect_method">The infect() method</h6>
<div class="paragraph">
<p>We saw that zombies infect humans by calling the human&#8217;s <code>infect()</code> method. This method
simply changes  the infected state from <code>False</code> to <code>True</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Human</span><span class="tok-p">(</span><span class="tok-n">core</span><span class="tok-o">.</span><span class="tok-n">Agent</span><span class="tok-p">):</span>
    <span class="tok-o">...</span>
    <span class="tok-k">def</span> <span class="tok-nf">infect</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">infected</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_saving_the_human_agent_state">Saving the Human Agent State</h5>
<div class="paragraph">
<p>To move the human agent between processes, we must save its state. Unlike our zombie agent, saving the human state entails saving its <code>infected</code> and <code>infected_duration</code> states <em>in addition to</em> its unique agent id tuple. The <code>save</code> method for the human agent was described in detail in
 <a href="#_saving_and_restoring_agents">Section 4.2, &#8220;Saving and Restoring Agents&#8221;</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_restoring_the_agents">7.1.3. Restoring the Agents</h4>
<div class="paragraph">
<p>The <code>restore_agent</code> function is used to create an individual zombie or human when that agent has moved to another process. This function is passed to the synchronize method (i.e., <code>self.context.synchronize(restore_agent)</code>) and is called in the synchronization mechanism. This function has also already
been  described in detail in <a href="#_saving_and_restoring_agents">Section 4.2, &#8220;Saving and Restoring Agents&#8221;</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_model_class_3">7.2. The Model class</h3>
<div class="paragraph">
<p>As was demonstrated in the earlier tutorials, the Model class encapsulates the simulation and is responsible for initialization, scheduling events, creating agents and their grid/space environment, and managing logging. In addition, the scheduled events that drive the simulation forward are methods of the Model class.</p>
</div>
<div class="sect3">
<h4 id="_scheduling_events_and_creating_the_context">7.2.1. Scheduling Events and Creating the Context</h4>
<div class="paragraph">
<p>For the Zombies model, the scheduling of events and the creation of the context are similar to the implementations in the <a href="#_tutorial_1_a_simple_random_walk_model">Random Walker Model</a>. Here both are implemented in the <code>Model</code> constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">core</span><span class="tok-p">,</span> <span class="tok-n">space</span><span class="tok-p">,</span> <span class="tok-n">schedule</span><span class="tok-p">,</span> <span class="tok-n">logging</span><span class="tok-p">,</span> <span class="tok-n">random</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">context</span> <span class="tok-k">as</span> <span class="tok-n">ctx</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.parameters</span> <span class="tok-kn">import</span> <span class="tok-n">create_args_parser</span><span class="tok-p">,</span> <span class="tok-n">init_params</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">comm</span> <span class="tok-o">=</span> <span class="tok-n">comm</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span> <span class="tok-o">=</span> <span class="tok-n">ctx</span><span class="tok-o">.</span><span class="tok-n">SharedContext</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_rank</span><span class="tok-p">()</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span> <span class="tok-o">=</span> <span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">init_schedule_runner</span><span class="tok-p">(</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_repeating_event</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">step</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_stop</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;stop.at&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule_end_event</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">at_end</span><span class="tok-p">)</span>     <i class="conum" data-value="5"></i><b>(5)</b>

        <span class="tok-o">...</span>
    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a context to hold the agents and the network projection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize schedule runner</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Schedule the repeating event of <code>Model.step</code>, beginning at tick 1 and repeating every tick thereafter</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Schedule the tick at which the simulation should stop, and events will no longer be executed</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Schedule a simulation end event to occur after events have stopped</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_spatial_projections">7.2.2. Implementing Spatial Projections</h4>
<div class="paragraph">
<p>After initializing the schedule, adding events, and creating the context to hold the population of agents,
the <code>Model</code> constructor creates the two spatial projections, the
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid"><code>SharedGrid</code></a> and the
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedCSpace"><code>SharedCSpace</code></a>.</p>
</div>
<div class="paragraph">
<p>Before we create our projections, we first must define a <code>BoundingBox</code> equal to the desired size of our space:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py</span> <span class="tok-kn">import</span> <span class="tok-n">space</span>

<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
        <span class="tok-o">...</span>
        <span class="tok-n">box</span> <span class="tok-o">=</span> <span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">BoundingBox</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;world.width&#39;</span><span class="tok-p">],</span>
                                <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;world.height&#39;</span><span class="tok-p">],</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span> <span class="tok-o">=</span> <span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">SharedGrid</span><span class="tok-p">(</span><span class="tok-s1">&#39;grid&#39;</span><span class="tok-p">,</span> <span class="tok-n">bounds</span><span class="tok-o">=</span><span class="tok-n">box</span><span class="tok-p">,</span> <span class="tok-n">borders</span><span class="tok-o">=</span><span class="tok-n">BorderType</span><span class="tok-o">.</span><span class="tok-n">Sticky</span><span class="tok-p">,</span>
                                     <span class="tok-n">occupancy</span><span class="tok-o">=</span><span class="tok-n">OccupancyType</span><span class="tok-o">.</span><span class="tok-n">Multiple</span><span class="tok-p">,</span>
                                     <span class="tok-n">buffer_size</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-o">=</span><span class="tok-n">comm</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add_projection</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">space</span> <span class="tok-o">=</span> <span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">SharedCSpace</span><span class="tok-p">(</span><span class="tok-s1">&#39;space&#39;</span><span class="tok-p">,</span> <span class="tok-n">bounds</span><span class="tok-o">=</span><span class="tok-n">box</span><span class="tok-p">,</span> <span class="tok-n">borders</span><span class="tok-o">=</span><span class="tok-n">BorderType</span><span class="tok-o">.</span><span class="tok-n">Sticky</span><span class="tok-p">,</span>
                                        <span class="tok-n">occupancy</span><span class="tok-o">=</span><span class="tok-n">OccupancyType</span><span class="tok-o">.</span><span class="tok-n">Multiple</span><span class="tok-p">,</span>
                                        <span class="tok-n">buffer_size</span><span class="tok-o">=</span><span class="tok-mi">2</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-o">=</span><span class="tok-n">comm</span><span class="tok-p">,</span>
                                        <span class="tok-n">tree_threshold</span><span class="tok-o">=</span><span class="tok-mi">100</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add_projection</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">space</span><span class="tok-p">)</span>    <i class="conum" data-value="5"></i><b>(5)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a  BoundingBox to initialize the size of the Cartesian spaces. Its
arguments are the minimum x coordinate, the extent of the x dimension, and then the same for
the y and z dimensions. Here we create a 2D box (the z extent is 0) starting at (0,0) and
extending for <code>params['world.width']</code> in the x dimension and <code>params['world.height']</code> in
the y dimension.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the grid projection. <code>repast4py.space.SharedGrid</code> takes a name, its bounds, its border,
and occupancy types, as well as a buffer size, and a MPI communicator as arguments. See the <code>SharedGrid</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid">API documentation</a>
for a description of these arguments. The concept of a buffer was described in the
<a href="#_distributed_simulation">Distributed Simulation</a> section.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the grid to the context so that it can be properly synchronized across
processes</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create the space projection. <code>repast4py.space.SharedCSpace</code> takes a name, its bounds, its border,
and occupancy types, as well as a buffer size, a MPI communicator, and a
tree threshold as arguments. See the <code>SharedCSpace</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedCSpace">API documentation</a>
for a description of these arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Add the space to the context so that it can be properly synchronized across
processes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We use two spatial projections in our Zombies model: a discrete <code>grid</code> projection, and a continuous <code>space</code> projection. Even though the <code>space</code> and <code>grid</code> projections are distinct from each other, they are
initialized with the same bounding box. Thus, they are the same size, which allows us to translate between the two projections such that the grid is overlaid on the continuous space. As you have seen, the
grid is used for neighborhood queries, and the continuous space for movement.</p>
</div>
<div class="paragraph">
<p>Within the <code>Model</code> class, a <code>move</code> method is defined and called during the movement
sections of the agents' step methods (<a href="#_the_zombie_step_method"><code>Zombie.step()</code></a> and <a href="#_the_human_step_method"><code>Human.step()</code></a>). This <code>move</code> method performs the translation and movement on both the
grid and continuous space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">ContinuousPoint</span> <span class="tok-k">as</span> <span class="tok-n">cpt</span>
<span class="tok-kn">from</span> <span class="tok-nn">repast4py.space</span> <span class="tok-kn">import</span> <span class="tok-n">DiscretePoint</span> <span class="tok-k">as</span> <span class="tok-n">dpt</span>
<span class="tok-o">...</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">move</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">agent</span><span class="tok-p">,</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">):</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">agent</span><span class="tok-p">,</span> <span class="tok-n">cpt</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">))</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">grid</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">agent</span><span class="tok-p">,</span> <span class="tok-n">dpt</span><span class="tok-p">(</span><span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">math</span><span class="tok-o">.</span><span class="tok-n">floor</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)),</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">math</span><span class="tok-o">.</span><span class="tok-n">floor</span><span class="tok-p">(</span><span class="tok-n">y</span><span class="tok-p">))))</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pass the <code>move</code> method the <code>x</code> and <code>y</code> coordinates in the <code>space</code> projection that the agent
argument is moving to.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Move the agent to the specified point in the continuous space, creating a new ContinuousPoint from
the x and y coordinates. See the <code>move</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedCSpace.move">API documentation</a> for
more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Move the agent to the corresponding location in the grid space. The grid takes
a DiscretePoint as its location argument. To create one, we take the floor of the
x and y coordinates, convert those to ints, and create a DiscretePoint from those ints.
See the <code>move</code>
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.space.html#repast4py.space.SharedGrid.move">API documentation</a> for
more details.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_agents_2">7.2.3. Creating the Agents</h4>
<div class="paragraph">
<p>The population of agents is created within the Model class. The model input
parameters <code>human.count</code> and <code>zombie.count</code> specify the total number of humans and zombies to create.
These total amounts are distributed evenly among each process rank,
with any remainder accounted for by assigning one agent to each rank,
starting with 0, until the total amount has been distributed.</p>
</div>
<div class="paragraph">
<p>Once the number of agents to create on each rank has been computed,
that number of agents is created, assigning each a random location
in the grid and continuous space.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_rank</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-o">...</span>
        <span class="tok-n">world_size</span> <span class="tok-o">=</span> <span class="tok-n">comm</span><span class="tok-o">.</span><span class="tok-n">Get_size</span><span class="tok-p">()</span>    <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="tok-n">total_human_count</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;human.count&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">pp_human_count</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">total_human_count</span> <span class="tok-o">/</span> <span class="tok-n">world_size</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">&lt;</span> <span class="tok-n">total_human_count</span> <span class="tok-o">%</span> <span class="tok-n">world_size</span><span class="tok-p">:</span>    <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="tok-n">pp_human_count</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>

        <span class="tok-n">local_bounds</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">space</span><span class="tok-o">.</span><span class="tok-n">get_local_bounds</span><span class="tok-p">()</span>    <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-k">for</span> <span class="tok-n">i</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-n">pp_human_count</span><span class="tok-p">):</span>    <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="tok-n">h</span> <span class="tok-o">=</span> <span class="tok-n">Human</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">h</span><span class="tok-p">)</span>    <i class="conum" data-value="9"></i><b>(9)</b>
            <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">(</span><span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xmin</span><span class="tok-p">,</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xmin</span>
                                           <span class="tok-o">+</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xextent</span><span class="tok-p">)</span>    <i class="conum" data-value="10"></i><b>(10)</b>
            <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">(</span><span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">ymin</span><span class="tok-p">,</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">ymin</span>
                                           <span class="tok-o">+</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">yextent</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">)</span>    <i class="conum" data-value="11"></i><b>(11)</b>

        <span class="tok-o">...</span>

    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the rank that is executing this code, the current process rank</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the number of process ranks over which the simulation is distributed</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the total number of Humans to create from the input parameters dictionary</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Compute the number of Human agents per processor</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Increment the number of agents to create on this rank, if this rank&#8217;s id is less than the number
of remaining agents to create. This will assign each rank, starting with 0, an additional agent
in order to reach the total when the total number of agents cannot be evenly divided among all the
process ranks.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Get the local bounds of the continuous space. Each rank is responsible for some
part of the total area defined by the space&#8217;s bounding box. For example, assuming
4 process ranks, each rank would be responsible for some quadrant of the space.
<code>get_local_bounds</code> returns the area that the calling rank is responsible for as
a <code>BoundingBox</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Iterate through the number of humans to be assigned to each rank</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Create a human agent</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Add the new human agent to the context</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Choose a random x and y location within the current local bounds using repast4py&#8217;s
default random number generator. See the <a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.random.html">API documentation</a> for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Move the new human agent to that location, using <code>Model.move</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code for creating the zombie agents is nearly identical, except that the
the <code>zombie.count</code> input parameter is used as the total number of agents to create,
and a zombie agent is created rather than a human.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>

        <span class="tok-o">...</span>

        <span class="tok-n">total_zombie_count</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;zombie.count&#39;</span><span class="tok-p">]</span>
        <span class="tok-n">pp_zombie_count</span> <span class="tok-o">=</span> <span class="tok-nb">int</span><span class="tok-p">(</span><span class="tok-n">total_zombie_count</span> <span class="tok-o">/</span> <span class="tok-n">world_size</span><span class="tok-p">)</span>
        <span class="tok-k">if</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span> <span class="tok-o">&lt;</span> <span class="tok-n">total_zombie_count</span> <span class="tok-o">%</span> <span class="tok-n">world_size</span><span class="tok-p">:</span>
            <span class="tok-n">pp_zombie_count</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>

        <span class="tok-k">for</span> <span class="tok-n">i</span> <span class="tok-ow">in</span> <span class="tok-nb">range</span><span class="tok-p">(</span><span class="tok-n">pp_zombie_count</span><span class="tok-p">):</span>
            <span class="tok-n">zo</span> <span class="tok-o">=</span> <span class="tok-n">Zombie</span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">zo</span><span class="tok-p">)</span>
            <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">(</span><span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xmin</span><span class="tok-p">,</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xmin</span> <span class="tok-o">+</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">xextent</span><span class="tok-p">)</span>
            <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">default_rng</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">(</span><span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">ymin</span><span class="tok-p">,</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">ymin</span> <span class="tok-o">+</span> <span class="tok-n">local_bounds</span><span class="tok-o">.</span><span class="tok-n">yextent</span><span class="tok-p">)</span>
            <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">zo</span><span class="tok-p">,</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">)</span>

        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">zombie_id</span> <span class="tok-o">=</span> <span class="tok-n">pp_zombie_count</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-o">...</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the next integer id for newly created zombies to the number of zombies created on this rank.
When a human becomes a zombie, this <code>zombie_id</code> is used as the id of that new zombie, and then incremented
for the next time a human becomes a zombie.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_logging_2">7.2.4. Logging</h4>
<div class="paragraph">
<p>As we saw in <a href="#_tutorial_1_a_simple_random_walk_model">Tutorial 1</a>, there are
two types of logging supported by Repast4Py, tabular and reduce-type logging (see the <code>repast4py.logging</code> module
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.logging.html#module-repast4py.logging">API documentation</a> for more information).</p>
</div>
<div class="paragraph">
<p>The Zombies model uses the second of these log types. The dataclass that we log records
the total number of humans and zombies each tick.</p>
</div>
<div class="sect4">
<h5 id="_initializing_logging_2">Initializing Logging</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nd">@dataclass</span>
<span class="tok-k">class</span> <span class="tok-nc">Counts</span><span class="tok-p">:</span>
    <span class="tok-n">humans</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
    <span class="tok-n">zombies</span><span class="tok-p">:</span> <span class="tok-nb">int</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>


<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">):</span>
        <span class="tok-o">...</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span> <span class="tok-o">=</span> <span class="tok-n">Counts</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">loggers</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">create_loggers</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-p">,</span> <span class="tok-n">op</span><span class="tok-o">=</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">SUM</span><span class="tok-p">,</span> <span class="tok-n">rank</span><span class="tok-o">=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span> <span class="tok-o">=</span> <span class="tok-n">logging</span><span class="tok-o">.</span><span class="tok-n">ReducingDataSet</span><span class="tok-p">(</span><span class="tok-n">loggers</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">comm</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;counts_file&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the <code>Counts</code> instance that we use to record the number of humans and zombies
on each rank</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a list of loggers that use <code>self.counts</code> as the source of the data to log,
and that perform a cross process rank summation of that data. The <code>names</code> argument is not
specified, so the <code>Counts</code> field names will be used as column headers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a <code>logging.ReducingDataSet</code> from the list of loggers. <code>params['counts_file']</code> is the name of the file to log to.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_log_counts_method">The <code>log_counts</code> Method</h5>
<div class="paragraph">
<p>At each tick the <code>log_counts</code> method is called by <code>Model.step()</code> to record the number
of humans and zombies at that tick.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">log_counts</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">tick</span><span class="tok-p">):</span>
        <span class="tok-c1"># Get the current number of zombies and humans and log</span>
        <span class="tok-n">num_agents</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">size</span><span class="tok-p">([</span><span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">,</span> <span class="tok-n">Zombie</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">])</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-o">.</span><span class="tok-n">humans</span> <span class="tok-o">=</span> <span class="tok-n">num_agents</span><span class="tok-p">[</span><span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">]</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">counts</span><span class="tok-o">.</span><span class="tok-n">zombies</span> <span class="tok-o">=</span> <span class="tok-n">num_agents</span><span class="tok-p">[</span><span class="tok-n">Zombie</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">]</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">log</span><span class="tok-p">(</span><span class="tok-n">tick</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the number of agents of the specified types currently in the context.
<a href="https://repast.github.io/repast4py.site/apidoc/source/repast4py.context.html#repast4py.context.SharedContext.size"><code>context.size</code></a>
takes a list of agent type ids and returns a dictionary where the type ids are the keys
and the values are the number of agents of that type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <code>self.counts.humans</code> to the number of humans</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the <code>self.counts.zombies</code> to the number of zombies</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Log the values for the specified tick. This will sum the values in <code>self.counts</code>
across all the ranks and log the results.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_scheduled_methods_3">7.2.5. Scheduled Methods</h4>
<div class="paragraph">
<p>The events for this model are methods defined within the Model class.</p>
</div>
<div class="sect4">
<h5 id="_step">Step</h5>
<div class="paragraph">
<p>The first of our scheduled events is the <code>step</code> method, which is scheduled to execute starting at tick 1 and for every tick thereafter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-o">...</span>

    <span class="tok-k">def</span> <span class="tok-nf">step</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-n">tick</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">schedule</span><span class="tok-o">.</span><span class="tok-n">tick</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">log_counts</span><span class="tok-p">(</span><span class="tok-n">tick</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">synchronize</span><span class="tok-p">(</span><span class="tok-n">restore_agent</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-k">for</span> <span class="tok-n">z</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">(</span><span class="tok-n">Zombie</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">):</span>    <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-n">z</span><span class="tok-o">.</span><span class="tok-n">step</span><span class="tok-p">()</span>

        <span class="tok-n">dead_humans</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-k">for</span> <span class="tok-n">h</span> <span class="tok-ow">in</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">agents</span><span class="tok-p">(</span><span class="tok-n">Human</span><span class="tok-o">.</span><span class="tok-n">TYPE</span><span class="tok-p">):</span>    <i class="conum" data-value="6"></i><b>(6)</b>
            <span class="tok-n">dead</span><span class="tok-p">,</span> <span class="tok-n">pt</span> <span class="tok-o">=</span> <span class="tok-n">h</span><span class="tok-o">.</span><span class="tok-n">step</span><span class="tok-p">()</span>
            <span class="tok-k">if</span> <span class="tok-n">dead</span><span class="tok-p">:</span>     <i class="conum" data-value="7"></i><b>(7)</b>
                <span class="tok-n">dead_humans</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">((</span><span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-p">))</span>

        <span class="tok-k">for</span> <span class="tok-n">h</span><span class="tok-p">,</span> <span class="tok-n">pt</span> <span class="tok-ow">in</span> <span class="tok-n">dead_humans</span><span class="tok-p">:</span> <i class="conum" data-value="8"></i><b>(8)</b>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">remove_agent</span><span class="tok-p">(</span><span class="tok-n">h</span><span class="tok-p">)</span>
            <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">add_zombie</span><span class="tok-p">(</span><span class="tok-n">pt</span><span class="tok-p">)</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the current tick value from the schedule runner</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Log the current number of humans and zombies by calling the <a href="#_the_log_counts_method"><code>log_counts</code></a> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Synchronize the state of the simulation across processes using the <code>restore_agent</code> function to restore any agents (Zombies and Humans) that have moved processes. See <a href="#_saving_and_restoring_agents">Section 4.2, &#8220;Saving and Restoring Agents&#8221;</a> for more details.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Iterate over all the Zombie agents in the model, calling <a href="#_the_zombie_step_method"><code>step</code></a> on each one.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create an empty list for collecting the dead humans and their current location. This is used
later in <code>step</code> to replace the humans with zombies.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Iterate over all the human agents in the model, calling <a href="#_the_human_step_method"><code>step</code></a> on each one.
<code>Human.step</code> returns a boolean that indicates whether or not the <code>Human</code> has died (and thus should become a <code>Zombie</code>), and the current location of that human.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If the human has died, then append it and its current location to the <code>dead_humans</code> list.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Iterate over the dead human data, removing the human from the model, and replacing it with a zombie
at its former location.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The iterator returned from <code>SharedContext.agents</code> is not modifiable during
iteration, that is, it is not possible to remove an agent from the <code>SharedContext</code> as part
of the iteration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Given that it is not possible to remove an agent as part of iteration, we need to
collect the humans to remove in a list. After the iteration has completed,
we can iterate over that list, and remove the agents using <code>Model.remove_agent</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">remove_agent</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">agent</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-n">agent</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remove the agent from the context.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Humans are converted into zombies in the <code>add_zombie()</code> method, which adds a new zombie agent at the final location of the newly removed human.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">add_zombie</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">z</span> <span class="tok-o">=</span> <span class="tok-n">Zombie</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">zombie_id</span><span class="tok-p">,</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">rank</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">zombie_id</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">context</span><span class="tok-o">.</span><span class="tok-n">add</span><span class="tok-p">(</span><span class="tok-n">z</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">move</span><span class="tok-p">(</span><span class="tok-n">z</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">pt</span><span class="tok-o">.</span><span class="tok-n">y</span><span class="tok-p">)</span>    <i class="conum" data-value="5"></i><b>(5)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The final location of the human agent that just died is passed into the <code>add_zombie</code> method</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a new zombie agent, using the <code>zombie_id</code> field instantiated in the constructor</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Increment the <code>zombie_id</code> to create the id for the next created zombie</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add the newly created zombie to the Model&#8217;s context</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Move the zombie to the location of the dead human the zombie is replacing</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_at_end">At End</h5>
<div class="paragraph">
<p><code>Model.at_end</code> runs when the simulation reaches its final tick and ends. This method closes the <code>data_set</code> log, ensuring that any remaining unwritten data is written to the output file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">at_end</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">data_set</span><span class="tok-o">.</span><span class="tok-n">close</span><span class="tok-p">()</span>
</pre></td></tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_grid_neighborhood_finder">7.3. The Grid Neighborhood Finder</h3>
<div class="paragraph">
<p>Every agent at every tick must search their neighborhood of grid locations to determine which grid location has the most humans or the fewest zombies. Because this neighborhood of grid locations is dependent on each agent&#8217;s current location, the neighborhood must be computed <em>every</em> tick for <em>every</em> agent. If, for example, the simulation is run for <em>50</em> ticks and <em>8400</em> agents, the neighborhood finding code is run over <em>400,000</em> times. Consequently, neighborhood finding is a good candidate for optimization, and a good example
of how such an optimization can be implemented using 3rd party Python libraries.</p>
</div>
<div class="paragraph">
<p>The <code>GridNghFinder</code> is a class that can quickly compute these neighboring grid locations
using the <a href="https://numpy.org">NumPy</a> and
<a href="https://numba.pydata.org">Numba</a> Python packages. NumPy is a fundamental Python package for
scientific computing, providing support for multi-dimensional arrays and matrices, along with
fast, optimized mathematical functions that operate on those arrays. Numba is a <em>just-in-time</em> compiler for Python. It can compile certain kinds of Python functions and classes into optimized
native machine code that bypasses the slower Python interpreter.
It is particularly useful for code that is numerically oriented and uses NumPy arrays.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>Numba</code> library provides a useful <a href="https://numba.readthedocs.io/en/stable/user/5minguide.html">"5 minute guide to Numba"</a> overview on their package&#8217;s webpage. We encourage you to take a look at that page for more information regarding how and why such a package may be useful when implementing your model. Similarly,
more information on <code>NumPy</code> and whether it might be useful for your model can be found <a href="https://numpy.org/doc/stable/user/whatisnumpy.html">here</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We implement our <code>GridNghFinder</code> as a class. Neighborhood finding in the <code>GridNghFinder</code>
works by taking a location and adding an array of offsets to that location to create a new array consisting of the neighboring
coordinates. For example, if we want to get the left and right coordinate values along the x-axis
for an x coordinate of 4, we can add the array [-1, 1] to 4 resulting in the array [3, 5]. The
<code>GridNghFinder</code> performs this operation using 9 element offset arrays in both the x and y
dimensions. 9 elements yields the Moore neighborhood coordinates as well as the original
center location. The <code>GridNghFinder</code> also performs some additional checks
to make sure that the coordinates are not outside of the bounds of the grid.
The arrays in this case are NumPy arrays, and given the numeric
nature of the operation, Numba can compile it into native code.</p>
</div>
<div class="paragraph">
<p>In order to utilize Numba for our <code>GridNghFinder</code> class, we must first declare the native data types of the fields used in our class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">numba</span> <span class="tok-kn">import</span> <span class="tok-n">int32</span>

<span class="tok-n">spec</span> <span class="tok-o">=</span> <span class="tok-p">[</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-p">(</span><span class="tok-s1">&#39;mo&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">[:]),</span>   <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">(</span><span class="tok-s1">&#39;no&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">[:]),</span>
    <span class="tok-p">(</span><span class="tok-s1">&#39;xmin&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">),</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-p">(</span><span class="tok-s1">&#39;ymin&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">),</span>
    <span class="tok-p">(</span><span class="tok-s1">&#39;ymax&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">),</span>
    <span class="tok-p">(</span><span class="tok-s1">&#39;xmax&#39;</span><span class="tok-p">,</span> <span class="tok-n">int32</span><span class="tok-p">)</span>
<span class="tok-p">]</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create a Numba class specification. The specification is a list of tuples,
where each tuple consists of a field name, and the native type of that field.
The names correspond to the field names in the class for which this is the specification.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a tuple for the <code>mo</code> field with a NumPy array of 32-bit integers as its type.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a tuple for the <code>xmin</code> field with a 32-bit integer type.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See the Numba <a href="https://numba.readthedocs.io/en/stable/user/jitclass.html">API documentation</a>
for <code>@jitclass</code> for more details on compiling classes with Numba.</p>
</div>
<div class="paragraph">
<p>The <code>GridNghFinder</code> constructor initializes the offset arrays and global grid bounds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">numba.experimental</span> <span class="tok-kn">import</span> <span class="tok-n">jitclass</span>    <i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-nd">@jitclass</span><span class="tok-p">(</span><span class="tok-n">spec</span><span class="tok-p">)</span>   <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">class</span> <span class="tok-nc">GridNghFinder</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-fm">__init__</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">xmin</span><span class="tok-p">,</span> <span class="tok-n">ymin</span><span class="tok-p">,</span> <span class="tok-n">xmax</span><span class="tok-p">,</span> <span class="tok-n">ymax</span><span class="tok-p">):</span>   <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">mo</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">array</span><span class="tok-p">([</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">],</span> <span class="tok-n">dtype</span><span class="tok-o">=</span><span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">int32</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">no</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">array</span><span class="tok-p">([</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-mi">0</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">],</span> <span class="tok-n">dtype</span><span class="tok-o">=</span><span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">int32</span><span class="tok-p">)</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">xmin</span> <span class="tok-o">=</span> <span class="tok-n">xmin</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ymin</span> <span class="tok-o">=</span> <span class="tok-n">ymin</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">xmax</span> <span class="tok-o">=</span> <span class="tok-n">xmax</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ymax</span> <span class="tok-o">=</span> <span class="tok-n">ymax</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import the <code>numba.jitclass</code> decorator</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Decorate <code>GridNghFinder</code> with <code>jitclass</code> passing our <code>spec</code> that defines the field types</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Pass the global grid bounds to the constructor as x and y maximum and minimum values</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create the <code>mo</code> and <code>no</code> offset arrays containing the specified 32-bit integers</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the minimum and maximum possible x and y values from the passed in global grid bounds</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The neighborhood coordinate computation is performed in the <code>find</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><pre><span></span>    <span class="tok-k">def</span> <span class="tok-nf">find</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">,</span> <span class="tok-n">x</span><span class="tok-p">,</span> <span class="tok-n">y</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">xs</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">mo</span> <span class="tok-o">+</span> <span class="tok-n">x</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">ys</span> <span class="tok-o">=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">no</span> <span class="tok-o">+</span> <span class="tok-n">y</span>    <i class="conum" data-value="3"></i><b>(3)</b>

        <span class="tok-n">xd</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">xs</span> <span class="tok-o">&gt;=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">xmin</span><span class="tok-p">)</span> <span class="tok-o">&amp;</span> <span class="tok-p">(</span><span class="tok-n">xs</span> <span class="tok-o">&lt;=</span><span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">xmax</span><span class="tok-p">)</span>    <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="tok-n">xs</span> <span class="tok-o">=</span> <span class="tok-n">xs</span><span class="tok-p">[</span><span class="tok-n">xd</span><span class="tok-p">]</span>   <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">ys</span> <span class="tok-o">=</span> <span class="tok-n">ys</span><span class="tok-p">[</span><span class="tok-n">xd</span><span class="tok-p">]</span>   <i class="conum" data-value="6"></i><b>(6)</b>

        <span class="tok-n">yd</span> <span class="tok-o">=</span> <span class="tok-p">(</span><span class="tok-n">ys</span> <span class="tok-o">&gt;=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ymin</span><span class="tok-p">)</span> <span class="tok-o">&amp;</span> <span class="tok-p">(</span><span class="tok-n">ys</span> <span class="tok-o">&lt;=</span> <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">ymax</span><span class="tok-p">)</span>    <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-n">xs</span> <span class="tok-o">=</span> <span class="tok-n">xs</span><span class="tok-p">[</span><span class="tok-n">yd</span><span class="tok-p">]</span>
        <span class="tok-n">ys</span> <span class="tok-o">=</span> <span class="tok-n">ys</span><span class="tok-p">[</span><span class="tok-n">yd</span><span class="tok-p">]</span>

        <span class="tok-k">return</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">stack</span><span class="tok-p">((</span><span class="tok-n">xs</span><span class="tok-p">,</span> <span class="tok-n">ys</span><span class="tok-p">,</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">zeros</span><span class="tok-p">(</span><span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">ys</span><span class="tok-p">),</span> <span class="tok-n">dtype</span><span class="tok-o">=</span><span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">int32</span><span class="tok-p">)),</span> <span class="tok-n">axis</span><span class="tok-o">=-</span><span class="tok-mi">1</span><span class="tok-p">)</span>    <i class="conum" data-value="8"></i><b>(8)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>find</code> method takes a 2D location specified as x and y coordinates. This location
is the location we want the neighboring coordinates of.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the x offset array to the x coordinate, resulting in a new array <code>xs</code> that contains the
neighboring x-axis coordinates.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the y offset array to the y coordinate, resulting in a new array <code>ys</code> that contains the
neighboring y-axis coordinates.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Compute the array indices in the <code>xs</code> array whose values are within the global x-axis bounds.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Keep only those values from <code>xs</code>, assigning that array to <code>xs</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Do the same for the <code>ys</code> array. If an x value is out of bounds, we discard its corresponding y value.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Compute the array indices in the <code>ys</code> array whose values are within the global y-axis bounds.
Then reset <code>xs</code> and <code>ys</code> to contain only the values at those indices.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Combine the <code>xs</code> and <code>ys</code> indices with each other and a z-axis coordinate array of all zeros
to create an array of arrays where the inner arrays are 3D points consisting of
x, y, and z coordinates. This 3 element array format is necessary to reset the
<code>repast4py.space.DiscretePoint</code> <code>at</code> variable that is used in both the <a href="#_the_zombie_step_method">Zombie step</a>, method and the <a href="#_the_human_step_method">Human step</a> method.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_simulation_3">7.4. Running the Simulation</h3>
<div class="paragraph">
<p>The simulation is run from the command line. For example, from within the
<code>examples/zombies</code> directory:</p>
</div>
<div class="paragraph">
<p><code>mpirun -n 4 python zombies.py zombie_model.yaml</code></p>
</div>
<div class="paragraph">
<p>Here we are running the simulation with 4 process ranks and the model input parameters are
in the <code>zombie_model.yaml</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><pre><span></span><span class="tok-nt">random.seed</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">42</span>
<span class="tok-nt">stop.at</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50.0</span>
<span class="tok-nt">human.count</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">8000</span>
<span class="tok-nt">zombie.count</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">400</span>
<span class="tok-nt">world.width</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200</span>
<span class="tok-nt">world.height</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">200</span>
<span class="tok-nt">run.number</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">1</span>
<span class="tok-nt">counts_file</span><span class="tok-p">:</span> <span class="tok-s">&#39;./output/agent_counts.csv&#39;</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Zombie Model uses the standard <code>if <em>name</em> == '<em>main</em>'</code> code block to parse the input parameters and
run the simulation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s2">&quot;__main__&quot;</span><span class="tok-p">:</span>
    <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">create_args_parser</span><span class="tok-p">()</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">parse_args</span><span class="tok-p">()</span>   <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-n">parameters</span><span class="tok-o">.</span><span class="tok-n">init_params</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters_file</span><span class="tok-p">,</span> <span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">parameters</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span>   <i class="conum" data-value="4"></i><b>(4)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the default command line argument parser</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parse the command line into its arguments using that default parser</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the model input parameters dictionary from those arguments using
<code>parameters.init_params</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call the <code>run</code> function to run the simulation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#_parsing_input_parameters">Parsing Input Parameters</a> in Tutorial 1 for more details.</p>
</div>
<div class="paragraph">
<p>The <code>run</code> function creates the Model class and calls its <code>run</code> method, which then begins the simulation by initiating schedule execution. This run function is called in the <code>if name == 'main'</code> code block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><pre><span></span><span class="tok-kn">from</span> <span class="tok-nn">mpi4py</span> <span class="tok-kn">import</span> <span class="tok-n">MPI</span>

<span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">):</span>
    <span class="tok-k">global</span> <span class="tok-n">model</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">model</span> <span class="tok-o">=</span> <span class="tok-n">Model</span><span class="tok-p">(</span><span class="tok-n">MPI</span><span class="tok-o">.</span><span class="tok-n">COMM_WORLD</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">)</span>   <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">model</span><span class="tok-o">.</span><span class="tok-n">run</span><span class="tok-p">()</span>

<span class="tok-k">class</span> <span class="tok-nc">Model</span><span class="tok-p">:</span>

    <span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-bp">self</span><span class="tok-p">):</span>
        <span class="tok-bp">self</span><span class="tok-o">.</span><span class="tok-n">runner</span><span class="tok-o">.</span><span class="tok-n">execute</span><span class="tok-p">()</span>    <i class="conum" data-value="3"></i><b>(3)</b>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>global</code> keyword to indicate that <code>model</code> refers to the module level <code>model</code> variable
and not a local variable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create the model instance, passing the Model constructor the MPI world communicator and the input parameters dictionary</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Start the simulation by executing the schedule which
calls the scheduled methods at the appropriate times and frequency</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The code in the <code>run</code> function could be moved to the <code>if <em>name</em> == '<em>main</em>'</code> code block,
but it is often useful to have an entry type function that initializes and starts a simulation.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Ozik, J., Wozniak, J. M., Collier, N., Macal, C. M., &amp; Binois, M. (2021). A population data-driven workflow for COVID-19 modeling and learning. The International Journal of High Performance Computing Applications, 35(5), 483–499. <a href="https://doi.org/10.1177/10943420211035164" class="bare">https://doi.org/10.1177/10943420211035164</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Ozik, J., Collier, N. T., Wozniak, J. M., Macal, C. M., &amp; An, G. (2018). Extreme-Scale Dynamic Exploration of a Distributed Agent-Based Model With the EMEWS Framework. IEEE Transactions on Computational Social Systems, 5(3), 884–895. <a href="https://doi.org/10.1109/TCSS.2018.2859189" class="bare">https://doi.org/10.1109/TCSS.2018.2859189</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Collier, N. T., Ozik, J., &amp; Tatara, E. R. (2020). Experiences in Developing a Distributed Agent-based Modeling Toolkit with Python. 2020 IEEE/ACM 9th Workshop on Python for High-Performance and Scientific Computing (PyHPC), 1–12. <a href="https://doi.org/10.1109/PyHPC51966.2020.00006" class="bare">https://doi.org/10.1109/PyHPC51966.2020.00006</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-09-17 12:05:30 -0400
</div>
</div>
</body>
</html>